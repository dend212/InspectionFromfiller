---
phase: 05-delivery-and-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/(dashboard)/inspections/page.tsx
  - src/components/dashboard/inspections-table.tsx
  - src/components/dashboard/search-bar.tsx
  - src/components/dashboard/status-tabs.tsx
autonomous: true
requirements: [DLVR-03, DLVR-04]

must_haves:
  truths:
    - "Dashboard shows all inspections in a table/list layout with columns for Address, Date, Customer Name, Status, Inspector, and Sent/Delivered"
    - "Status badges are colored: Draft = gray, In Review = yellow/amber, Complete = green"
    - "Default sort is newest inspections first"
    - "Clickable column headers re-sort the table"
    - "Single search box searches across address, customer name, and date with real-time filtering"
    - "Tab-style status filters (All | Draft | In Review | Complete) filter the table and combine with text search"
    - "Dan can find past inspections quickly by address, date, or customer name"
  artifacts:
    - path: "src/app/(dashboard)/inspections/page.tsx"
      provides: "Server component with searchParams-based data fetching, filtering, sorting"
      contains: "searchParams"
    - path: "src/components/dashboard/inspections-table.tsx"
      provides: "Table component with sortable column headers, status badges, action buttons"
      exports: ["InspectionsTable"]
    - path: "src/components/dashboard/search-bar.tsx"
      provides: "Debounced search input that updates URL searchParams"
      exports: ["SearchBar"]
    - path: "src/components/dashboard/status-tabs.tsx"
      provides: "Tab-style status filter buttons (All, Draft, In Review, Complete)"
      exports: ["StatusTabs"]
  key_links:
    - from: "src/components/dashboard/search-bar.tsx"
      to: "src/app/(dashboard)/inspections/page.tsx"
      via: "URL searchParams update triggers server re-render"
      pattern: "router\\.replace.*searchParams"
    - from: "src/components/dashboard/status-tabs.tsx"
      to: "src/app/(dashboard)/inspections/page.tsx"
      via: "URL searchParams update triggers server re-render"
      pattern: "router\\.replace.*status"
    - from: "src/app/(dashboard)/inspections/page.tsx"
      to: "src/lib/db/schema.ts"
      via: "Drizzle query with conditional filters"
      pattern: "ilike|or|and|eq"
---

<objective>
Replace the card-grid inspections page with a searchable, filterable table dashboard.

Purpose: Dan needs to see all inspections at a glance with their status, search by address/name/date, and filter by status -- all in a professional table layout. This is the primary interface Dan uses daily to manage inspection workflow.

Output: Table-based inspections page with sortable columns, status badges, real-time search bar, status tab filters, and pagination.
</objective>

<execution_context>
@/Users/danielendres/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danielendres/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-delivery-and-dashboard/05-RESEARCH.md
@.planning/phases/05-delivery-and-dashboard/05-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. -->

From src/lib/db/schema.ts (updated in 05-01):
```typescript
export const inspections = pgTable("inspections", {
  id: uuid("id").defaultRandom().primaryKey(),
  inspectorId: uuid("inspector_id").references(() => profiles.id).notNull(),
  status: inspectionStatusEnum("status").default("draft").notNull(),
  facilityName: text("facility_name"),
  facilityAddress: text("facility_address"),
  facilityCity: text("facility_city"),
  facilityCounty: text("facility_county"),
  facilityState: varchar("facility_state", { length: 2 }).default("AZ"),
  facilityZip: varchar("facility_zip", { length: 10 }),
  customerEmail: text("customer_email"),       // NEW in 05-01
  customerName: text("customer_name"),         // NEW in 05-01
  formData: jsonb("form_data"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
  submittedAt: timestamp("submitted_at"),
  completedAt: timestamp("completed_at"),
  reviewNotes: text("review_notes"),
  finalizedPdfPath: text("finalized_pdf_path"),
  reviewedBy: uuid("reviewed_by").references(() => profiles.id),
});

export const inspectionStatusEnum = pgEnum("inspection_status", [
  "draft", "submitted", "in_review", "completed", "sent",
]);

export const profiles = pgTable("profiles", {
  id: uuid("id").primaryKey(),
  fullName: text("full_name").notNull(),
  email: text("email").notNull(),
  // ...
});

export const inspectionEmails = pgTable("inspection_emails", {
  // ... send history (used by 05-02)
});
```

From src/components/ui/table.tsx:
```typescript
export { Table, TableHeader, TableBody, TableFooter, TableHead, TableRow, TableCell, TableCaption };
```

From src/components/ui/badge.tsx:
```typescript
export { Badge, badgeVariants };
```

From src/components/ui/button.tsx:
```typescript
export { Button, buttonVariants };
```

From src/components/ui/input.tsx:
```typescript
export { Input };
```

Current inspections page (src/app/(dashboard)/inspections/page.tsx):
```typescript
// Currently renders card grid with Link + Card per inspection
// Has getUserRole helper, STATUS_LABELS, STATUS_VARIANTS, formatDate
// Queries inspections table with role-based filtering
// Role check: isPrivileged (admin/office_staff) sees all, field_tech sees own
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Search bar and status tabs client components</name>
  <files>
    src/components/dashboard/search-bar.tsx
    src/components/dashboard/status-tabs.tsx
  </files>
  <action>
    **SearchBar component** (`src/components/dashboard/search-bar.tsx`):
    "use client" component that updates URL searchParams with debounced input.

    ```typescript
    interface SearchBarProps {
      defaultValue?: string;
    }
    ```

    Implementation:
    1. Use `useRouter`, `useSearchParams`, and `usePathname` from `next/navigation`.
    2. Render an Input with Search icon (from lucide-react) as a left icon decoration. Placeholder: "Search by address, name, or date...".
    3. On input change, debounce 300ms using `setTimeout` + `useRef<NodeJS.Timeout>` pattern (per RESEARCH.md Pattern 5).
    4. After debounce: create new URLSearchParams from current, set `q` param if term is non-empty or delete if empty. Also delete `page` param (reset to page 1 on new search). Call `router.replace(\`\${pathname}?\${params.toString()}\`)`.
    5. Set default input value from `defaultValue` prop (synced from URL on server render).
    6. Include a clear button (X icon) when input has value -- clicking clears input and removes `q` param.

    **StatusTabs component** (`src/components/dashboard/status-tabs.tsx`):
    "use client" component rendering tab-style status filter buttons.

    ```typescript
    interface StatusTabsProps {
      activeStatus: string;
    }
    ```

    Implementation:
    1. Render a horizontal button group with tabs: "All", "Draft", "In Review", "Complete".
    2. Map tab labels to URL status values: `all` (no filter), `draft`, `in_review`, `completed`.
    3. Active tab highlighted with primary variant, others use outline/ghost.
    4. On click: update URL searchParams to set `status` (or delete for "All"). Preserve existing `q` and `sort`/`order` params. Delete `page` param (reset pagination).
    5. Use `useRouter`, `useSearchParams`, `usePathname`.
    6. Include count badges next to each tab name (passed as optional prop `counts?: { all: number; draft: number; in_review: number; completed: number }`) -- render as small Badge next to label text. If counts not provided, omit badges.
  </action>
  <verify>
    Run `npx tsc --noEmit`. Verify SearchBar and StatusTabs are exported from their respective files. Check that both use `useRouter` and `useSearchParams` for URL-based state management.
  </verify>
  <done>
    SearchBar debounces input and updates `q` searchParam. StatusTabs renders filter buttons and updates `status` searchParam. Both preserve other params and reset pagination.
  </done>
</task>

<task type="auto">
  <name>Task 2: Inspections table component and server page with search/filter/sort</name>
  <files>
    src/components/dashboard/inspections-table.tsx
    src/app/(dashboard)/inspections/page.tsx
  </files>
  <action>
    **InspectionsTable component** (`src/components/dashboard/inspections-table.tsx`):
    "use client" component rendering the data table.

    Props:
    ```typescript
    interface InspectionRow {
      id: string;
      facilityAddress: string | null;
      customerName: string | null;
      status: string;
      inspectorName: string;
      createdAt: string; // ISO string
      completedAt: string | null;
      finalizedPdfPath: string | null;
      emailSentCount: number;
    }

    interface InspectionsTableProps {
      inspections: InspectionRow[];
      sortColumn: string;
      sortOrder: string;
      isPrivileged: boolean;
    }
    ```

    Implementation:
    1. Render using shadcn Table, TableHeader, TableBody, TableHead, TableRow, TableCell components.
    2. Columns per CONTEXT.md: Address, Date, Customer Name, Status, Inspector, Sent/Delivered.
    3. **Address column**: Display `facilityAddress` or "No address". Truncate long addresses with `truncate` class, max-w-[200px].
    4. **Date column**: Format `createdAt` as "MMM DD, YYYY" using Intl.DateTimeFormat.
    5. **Customer Name column**: Display `customerName` or em dash. Truncate at max-w-[150px].
    6. **Status column**: Render colored Badge per CONTEXT.md:
       - draft → `<Badge variant="secondary">Draft</Badge>` (gray)
       - submitted / in_review → `<Badge className="bg-amber-100 text-amber-800 hover:bg-amber-200">In Review</Badge>` (yellow/amber)
       - completed → `<Badge className="bg-green-100 text-green-800 hover:bg-green-200">Complete</Badge>` (green)
       - sent → `<Badge className="bg-green-100 text-green-800 hover:bg-green-200">Sent</Badge>` (green)
    7. **Inspector column**: Display `inspectorName`.
    8. **Sent column**: If `emailSentCount > 0`, show Check icon (green) with count. If `finalizedPdfPath` exists but no emails sent, show "Ready". Otherwise em dash.
    9. **Clickable column headers** for re-sorting per CONTEXT.md: Address, Date, Customer Name, Status. Use ArrowUpDown icon from lucide-react. On click, update URL searchParams with `sort={column}` and `order={asc|desc}` (toggle direction if same column clicked). Use `useRouter`, `useSearchParams`, `usePathname`.
    10. **Row click**: Navigate to inspection based on status and role (same logic as current page):
        - draft → `/inspections/{id}/edit`
        - isPrivileged + non-draft → `/review/{id}`
        - field tech + non-draft → `/inspections/{id}`
    11. **Row actions column**: Small icon buttons visible on hover:
        - Download button (Download icon) for completed/sent inspections with `finalizedPdfPath`. On click, fetch `/api/inspections/{id}/download`, open the returned `downloadUrl` in new tab.
        - View button (Eye icon) linking to `/inspections/{id}` always.
    12. **Empty state**: If `inspections` array is empty, render a centered message: "No inspections found" with "Try adjusting your search or filters" subtitle and a "Clear Filters" button that navigates to `/inspections`.
    13. **Pagination**: Simple prev/next pagination at bottom. Accept `page` and `totalPages` props. Render "Showing {start}-{end} of {total}" text and prev/next buttons that update `page` searchParam. 20 items per page.

    Update the InspectionsTableProps to include `page`, `totalPages`, and `totalCount` for pagination.

    **Inspections page** (`src/app/(dashboard)/inspections/page.tsx`):
    REPLACE the current card-grid implementation with the new table dashboard.

    Server component structure:
    ```typescript
    export default async function InspectionsPage({
      searchParams,
    }: {
      searchParams: Promise<{
        q?: string;
        status?: string;
        sort?: string;
        order?: string;
        page?: string;
      }>;
    }) {
    ```

    Implementation:
    1. Auth check (keep existing pattern).
    2. Extract role (keep existing `getUserRole` helper).
    3. `const { q, status, sort, order, page } = await searchParams;`
    4. Build Drizzle query with conditional filters:
       ```typescript
       import { ilike, or, and, eq, desc, asc, sql, count } from "drizzle-orm";
       ```
       - **Status filter**: If `status` is provided and not "all", filter by `eq(inspections.status, status)`.
       - **Text search**: If `q` is provided, search across:
         - `ilike(inspections.facilityAddress, \`%\${q}%\`)`
         - `ilike(inspections.facilityCity, \`%\${q}%\`)`
         - `ilike(inspections.facilityName, \`%\${q}%\`)`
         - `ilike(inspections.customerName, \`%\${q}%\`)`
         Combined with `or()`.
       - **Role filter**: If not privileged, add `eq(inspections.inspectorId, user.id)`.
       - Combine all filters with `and()`.
    5. **Sorting**: Map sort param to column:
       - "address" → `inspections.facilityAddress`
       - "date" → `inspections.createdAt`
       - "customer" → `inspections.customerName`
       - "status" → `inspections.status`
       - default → `inspections.createdAt`
       Apply `asc()` or `desc()` based on `order` param (default: "desc" for newest first per CONTEXT.md).
    6. **Pagination**: 20 per page. Calculate `offset = (pageNum - 1) * 20`. Use `.limit(20).offset(offset)`.
    7. **Count query**: Run a separate count query with the same filters to get total for pagination.
    8. **Join for inspector name**: Left join with profiles table to get `profiles.fullName` as `inspectorName`:
       ```typescript
       .leftJoin(profiles, eq(inspections.inspectorId, profiles.id))
       ```
    9. **Email sent count**: Use a subquery or separate query to count emails per inspection. Simplest approach: after main query, fetch email counts in bulk for the page's inspection IDs.
       ```typescript
       const emailCounts = await db
         .select({
           inspectionId: inspectionEmails.inspectionId,
           count: count(),
         })
         .from(inspectionEmails)
         .where(inArray(inspectionEmails.inspectionId, inspectionIds))
         .groupBy(inspectionEmails.inspectionId);
       ```
       Import `inArray` from `drizzle-orm`.
    10. **Status counts for tabs**: Run a quick aggregation query for tab counts (grouped by status), apply role filter but NOT text search (so counts reflect all inspections in each status).
    11. Render layout:
        ```tsx
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <h1 className="text-2xl font-bold tracking-tight">Inspections</h1>
            <Button asChild><Link href="/inspections/new">New Inspection</Link></Button>
          </div>
          <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <StatusTabs activeStatus={status || "all"} counts={statusCounts} />
            <SearchBar defaultValue={q} />
          </div>
          <InspectionsTable
            inspections={mappedRows}
            sortColumn={sort || "date"}
            sortOrder={order || "desc"}
            isPrivileged={isPrivileged}
            page={pageNum}
            totalPages={totalPages}
            totalCount={totalCount}
          />
        </div>
        ```
    12. Remove all Card component imports since we're replacing cards with table.
  </action>
  <verify>
    Run `npx tsc --noEmit`. Verify InspectionsTable is exported and used in the page. Verify the page accepts async searchParams. Check that Drizzle query uses `ilike`, `or`, `and` for search filtering. Verify status badge colors match CONTEXT.md (gray, amber, green).
  </verify>
  <done>
    Dashboard shows inspections in a table with Address, Date, Customer Name, Status, Inspector, Sent/Delivered columns. Status badges colored per spec. Default sort newest first. Column headers clickable for re-sorting. Search box filters across address, customer name, date. Status tabs filter by status and combine with search. Pagination at 20/page.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Inspections page renders table layout (not cards)
3. Columns match CONTEXT.md: Address, Date, Customer Name, Status, Inspector, Sent/Delivered
4. Status badges: Draft = gray, In Review = amber, Complete = green
5. Default sort: newest first
6. Column headers clickable for re-sorting
7. Search box filters table live (300ms debounce)
8. Status tabs (All | Draft | In Review | Complete) filter independently and combine with search
9. Pagination works (20 per page, prev/next buttons)
10. Empty state shows helpful message with clear filters option
</verification>

<success_criteria>
- Dashboard table replaces card grid with all required columns
- Search by address, customer name, or date returns matching results immediately
- Status tabs filter independently and combine with text search
- Column sorting works via clickable headers
- Pagination handles growing dataset
- Field techs see only their own inspections; admin/office_staff see all
</success_criteria>

<output>
After completion, create `.planning/phases/05-delivery-and-dashboard/05-03-SUMMARY.md`
</output>
