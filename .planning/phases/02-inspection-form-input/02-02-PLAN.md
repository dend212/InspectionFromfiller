---
phase: 02-inspection-form-input
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/components/inspection/inspection-wizard.tsx
  - src/components/inspection/wizard-progress.tsx
  - src/components/inspection/wizard-navigation.tsx
  - src/components/inspection/step-facility-info.tsx
  - src/components/inspection/step-general-treatment.tsx
  - src/components/inspection/step-design-flow.tsx
  - src/components/inspection/step-septic-tank.tsx
  - src/components/inspection/step-disposal-works.tsx
  - src/hooks/use-auto-save.ts
  - src/app/(dashboard)/inspections/[id]/edit/page.tsx
autonomous: true
requirements: [FORM-01, FORM-02, FORM-03, FORM-04]

must_haves:
  truths:
    - "Field tech can step through all 5 form sections on a mobile screen using Next/Back buttons"
    - "Step dots progress indicator shows current position across 5 steps"
    - "Rarely-used alternative system fields in Section 2 are hidden by default behind a toggle switch"
    - "Form auto-saves on field changes via debounced PATCH to the API"
    - "Inspector info is pre-filled when loading a new inspection (company, cert number, reg number, truck number, inspector name)"
    - "Closing the browser and reopening restores all previously entered data"
    - "Validation highlights incomplete required fields on Next but does not block navigation"
    - "Submit button on the last step (Disposal Works) enforces all validation before submitting"
    - "Septic tank condition checkboxes render as large tap-friendly toggle rows"
  artifacts:
    - path: "src/components/inspection/inspection-wizard.tsx"
      provides: "Wizard shell with single useForm instance, step state, auto-save integration"
      min_lines: 60
    - path: "src/components/inspection/wizard-progress.tsx"
      provides: "5-dot step progress indicator"
    - path: "src/components/inspection/wizard-navigation.tsx"
      provides: "Next/Back/Submit button bar"
    - path: "src/components/inspection/step-facility-info.tsx"
      provides: "Step 1 form fields"
    - path: "src/components/inspection/step-general-treatment.tsx"
      provides: "Step 2 form fields with conditional toggle for alternative systems"
    - path: "src/components/inspection/step-design-flow.tsx"
      provides: "Step 3 form fields"
    - path: "src/components/inspection/step-septic-tank.tsx"
      provides: "Step 4 form fields with large tap-friendly toggle rows"
    - path: "src/components/inspection/step-disposal-works.tsx"
      provides: "Step 5 form fields with Submit button"
    - path: "src/hooks/use-auto-save.ts"
      provides: "Debounced auto-save hook using useWatch"
    - path: "src/app/(dashboard)/inspections/[id]/edit/page.tsx"
      provides: "Edit page that loads inspection and renders wizard"
  key_links:
    - from: "src/components/inspection/inspection-wizard.tsx"
      to: "src/lib/validators/inspection.ts"
      via: "zodResolver(inspectionFormSchema) for form validation"
      pattern: "zodResolver\\(inspectionFormSchema\\)"
    - from: "src/hooks/use-auto-save.ts"
      to: "src/app/api/inspections/[id]/route.ts"
      via: "fetch PATCH to /api/inspections/[id]"
      pattern: "fetch.*api/inspections"
    - from: "src/app/(dashboard)/inspections/[id]/edit/page.tsx"
      to: "src/components/inspection/inspection-wizard.tsx"
      via: "Loads inspection data then renders InspectionWizard with defaultValues"
      pattern: "InspectionWizard"
    - from: "src/components/inspection/step-general-treatment.tsx"
      to: "src/lib/constants/inspection.ts"
      via: "Imports GP402_SYSTEM_TYPES and uses Switch for conditional fields"
      pattern: "Switch|alternativeSystem"
---

<objective>
Build the complete 5-step inspection form wizard with all ADEQ sections rendered as mobile-first form fields, auto-save on blur, warn-but-allow validation, and conditional toggle sections.

Purpose: This is the core user-facing form experience. Field techs on their phones step through the 5 ADEQ GWS 432 sections, entering inspection data that auto-saves to the server. The form must feel native on mobile with large touch targets, and restore all data on reload.

Output: Wizard shell, 5 step components, auto-save hook, edit page, progress indicator, navigation bar.
</objective>

<execution_context>
@/Users/danielendres/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danielendres/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-inspection-form-input/02-RESEARCH.md
@.planning/phases/02-inspection-form-input/02-01-SUMMARY.md

<interfaces>
<!-- Contracts from Plan 02-01 that this plan builds against -->

From src/lib/validators/inspection.ts (created in 02-01):
```typescript
export const facilityInfoSchema: z.ZodObject<...>;
export const generalTreatmentSchema: z.ZodObject<...>;
export const designFlowSchema: z.ZodObject<...>;
export const septicTankSchema: z.ZodObject<...>;
export const disposalWorksSchema: z.ZodObject<...>;
export const inspectionFormSchema: z.ZodObject<{
  facilityInfo: typeof facilityInfoSchema;
  generalTreatment: typeof generalTreatmentSchema;
  designFlow: typeof designFlowSchema;
  septicTank: typeof septicTankSchema;
  disposalWorks: typeof disposalWorksSchema;
}>;
export const STEP_FIELDS: Record<number, string[]>;
export function getDefaultFormValues(inspectorName: string): InspectionFormData;
```

From src/lib/constants/inspection.ts (created in 02-01):
```typescript
export const AZ_COUNTIES: { value: string; label: string }[];
export const FACILITY_TYPES: { value: string; label: string }[];
export const INSPECTION_TYPES: { value: string; label: string }[];
export const GP402_SYSTEM_TYPES: { value: string; label: string }[];
export const TANK_MATERIALS: { value: string; label: string }[];
export const DISPOSAL_TYPES: { value: string; label: string }[];
export const CONDITION_OPTIONS: { value: string; label: string }[];
export const INSPECTOR_DEFAULTS: { company: string; certificationNumber: string; registrationNumber: string; truckNumber: string };
export const STEP_LABELS: string[];
```

From src/types/inspection.ts (created in 02-01):
```typescript
export type InspectionFormData = z.infer<typeof inspectionFormSchema>;
export type FacilityInfo = z.infer<typeof facilityInfoSchema>;
export type GeneralTreatment = z.infer<typeof generalTreatmentSchema>;
export type DesignFlow = z.infer<typeof designFlowSchema>;
export type SepticTank = z.infer<typeof septicTankSchema>;
export type DisposalWorks = z.infer<typeof disposalWorksSchema>;
```

From src/app/api/inspections/[id]/route.ts (created in 02-01):
```typescript
// GET: returns { id, inspectorId, status, formData, ... }
// PATCH: accepts JSON body (form data), returns { saved: true }
```

From existing codebase:
```typescript
// src/lib/supabase/server.ts
export async function createClient(): Promise<SupabaseClient>;

// src/lib/supabase/client.ts (browser)
export function createClient(): SupabaseClient;

// src/components/ui/ -- shadcn components available:
// button, card, form, input, label, select, sheet, badge, table, sonner
// NEW (installed in 02-01): switch, checkbox, textarea, separator
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build wizard shell, progress indicator, navigation, auto-save hook, and edit page</name>
  <files>
    src/components/inspection/inspection-wizard.tsx
    src/components/inspection/wizard-progress.tsx
    src/components/inspection/wizard-navigation.tsx
    src/hooks/use-auto-save.ts
    src/app/(dashboard)/inspections/[id]/edit/page.tsx
  </files>
  <action>
**1. `src/hooks/use-auto-save.ts`** -- Debounced auto-save hook:
- `"use client"` directive
- Export `useAutoSave(form: UseFormReturn<any>, inspectionId: string, debounceMs = 1000)`
- Use `useWatch({ control: form.control })` to observe all form values (import from `react-hook-form`)
- Keep a `lastSavedRef` (useRef<string>) to skip saves when data hasn't changed (compare JSON.stringify)
- Keep a `timeoutRef` for debounce cleanup
- On value change: clear existing timeout, set new timeout that calls `fetch(`/api/inspections/${inspectionId}`, { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) })`
- On successful save: update `lastSavedRef`, optionally expose a `lastSaved` timestamp state
- On error: show error toast via `toast.error("Auto-save failed")` from sonner
- On unmount: flush any pending save immediately (clear timeout and save if dirty)
- Add `beforeunload` event listener that warns if there are unsaved changes
- Export a `saving` boolean state so the UI can show a save indicator

**CRITICAL:** Isolate useWatch in this hook/component -- do NOT place it in the wizard root. This prevents full-form re-renders on every keystroke (see Research pitfall #4).

**2. `src/components/inspection/wizard-progress.tsx`** -- Step dots progress indicator:
- `"use client"` directive
- Props: `currentStep: number`, `onStepClick?: (step: number) => void`
- Import `STEP_LABELS` from `@/lib/constants/inspection`
- Render 5 numbered circles (1-5) in a horizontal flex row
- Current step: primary background with white text
- Completed steps (index < currentStep): lighter primary tint
- Future steps: muted background
- Each dot is a `<button>` with `onClick={() => onStepClick?.(index)}` for direct step navigation
- Below each dot (on larger screens) or as aria-label: the step label
- Mobile: just show dots without labels (they get too cramped)
- Minimum 44px touch target per WCAG guidelines

**3. `src/components/inspection/wizard-navigation.tsx`** -- Next/Back/Submit bar:
- `"use client"` directive
- Props: `currentStep: number`, `onNext: () => void`, `onBack: () => void`, `isLastStep: boolean`, `isSubmitting: boolean`
- Fixed at bottom of screen on mobile (`sticky bottom-0`) with background blur for visibility while scrolling
- Back button: hidden on step 0, secondary variant
- Next button: shown on steps 0-3, primary variant
- Submit button: shown on step 4 (last step) only, primary variant, type="submit"
- All buttons: `min-h-[48px]` for mobile tap targets
- Show a save indicator ("Saving..." / "Saved") that receives state from auto-save hook

**4. `src/components/inspection/inspection-wizard.tsx`** -- Wizard shell:
- `"use client"` directive
- Props: `inspection: { id: string; formData: InspectionFormData | null; status: string }`
- Create a single `useForm<InspectionFormData>()` with:
  - `resolver: zodResolver(inspectionFormSchema)` from `@hookform/resolvers/zod`
  - `defaultValues: inspection.formData ?? getDefaultFormValues("")` (the actual inspector name comes from the saved formData)
  - `mode: "onBlur"` (validate on blur for auto-save trigger)
- `useState` for `currentStep` (0-4)
- Call `useAutoSave(form, inspection.id)` -- this sets up auto-save in an isolated hook
- `handleNext`: call `await form.trigger(STEP_FIELDS[currentStep])` to highlight errors, then always advance: `setCurrentStep(prev => Math.min(prev + 1, 4))`. This is the warn-but-allow pattern from CONTEXT.md.
- `handleBack`: `setCurrentStep(prev => Math.max(prev - 1, 0))`
- `handleStepClick(step)`: direct navigation to any step (from progress dots)
- `handleSubmit`: `form.handleSubmit(async (data) => { ... })` -- on the final step, enforce ALL validation. If valid, PATCH to save final data, then update status to "submitted" via a separate API call or include in the PATCH. For now, just save the data (status change is Phase 4).
- Render: `<Form {...form}><form onSubmit={handleSubmit}>` wrapping:
  - `<WizardProgress currentStep={currentStep} onStepClick={handleStepClick} />`
  - Step title as an h2 showing the current step label
  - Conditional rendering of step components: `{currentStep === 0 && <StepFacilityInfo />}` etc.
  - `<WizardNavigation currentStep={currentStep} onNext={handleNext} onBack={handleBack} isLastStep={currentStep === 4} />`
- Import all 5 step components (they'll be created in Task 2)

**5. `src/app/(dashboard)/inspections/[id]/edit/page.tsx`** -- Edit page:
- Server component
- Authenticate via `createClient()` + `getUser()`, redirect to `/login` if not authenticated
- Extract `id` from params: `const { id } = await params;`
- Load inspection from database via Drizzle: `db.select().from(inspections).where(eq(inspections.id, id)).limit(1)`
- If not found: redirect to `/inspections` (or show 404)
- Verify ownership: if user is field_tech, inspection.inspectorId must match user.id
- Pass inspection data to `<InspectionWizard inspection={{ id: inspection.id, formData: inspection.formData, status: inspection.status }} />`
- Page metadata: `<title>Edit Inspection</title>`
  </action>
  <verify>
    <automated>cd "/Users/danielendres/Documents/Dans Stuff/Inspection Form Filler" && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - InspectionWizard renders with a single useForm instance and zodResolver
    - WizardProgress shows 5 clickable step dots with current/completed/future states
    - WizardNavigation shows Back/Next/Submit buttons with 48px min height
    - useAutoSave debounces and PATCHes form data to the API on changes
    - Edit page loads inspection from DB and passes to wizard
    - TypeScript compiles with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Build all 5 ADEQ form step components with mobile-first fields, toggles, and tap-friendly rows</name>
  <files>
    src/components/inspection/step-facility-info.tsx
    src/components/inspection/step-general-treatment.tsx
    src/components/inspection/step-design-flow.tsx
    src/components/inspection/step-septic-tank.tsx
    src/components/inspection/step-disposal-works.tsx
  </files>
  <action>
All step components share these patterns:
- `"use client"` directive
- Use `useFormContext()` from `react-hook-form` to access the parent form (no props needed for form state)
- Use shadcn/ui `FormField`, `FormItem`, `FormLabel`, `FormControl`, `FormMessage` for each field
- Use `FormDescription` for helper text where needed
- Import constants from `@/lib/constants/inspection` for dropdown options
- Mobile-first layout: single column on mobile, 2 columns on larger screens (`grid grid-cols-1 sm:grid-cols-2 gap-4`)
- All interactive elements: minimum 44px height for touch targets
- Field groups separated by `<Separator />` with section subheadings

**1. `src/components/inspection/step-facility-info.tsx`** -- Step 1: Facility Information
- Section: Facility details (name, address, city, county dropdown, state=AZ, zip)
- Section: Owner info (name, address, phone, contact person)
- Section: Inspection details (facility type dropdown, date, APP #, inspection type dropdown)
- Section: Inspector credentials (inspectorName, company, certificationNumber, registrationNumber, truckNumber) -- these are pre-filled and typically not edited, but still editable
- Use `<Input>` for text fields, `<Select>` for dropdowns (county, facility type, inspection type)
- Date field: use `<Input type="date">` (native date picker on mobile)

**2. `src/components/inspection/step-general-treatment.tsx`** -- Step 2: General Treatment
- GP 4.02 System: yes/no selection + Type I/II/III/IV dropdown
- **Conditional toggle (FORM-02):** A `<Switch>` labeled "Alternative Treatment System" with description "Show fields for non-standard system types". When OFF (default), alternative fields are hidden. When ON, reveal: manufacturer, model, capacity, date installed, system condition fields.
- The toggle state is stored in the form as `generalTreatment.alternativeSystem` (boolean) -- persists with auto-save
- Wrap conditional fields in a container with `border-l-2 border-primary/20 pl-4` visual indicator
- System condition fields as needed

**3. `src/components/inspection/step-design-flow.tsx`** -- Step 3: Design Flow Calculations
- Number of bedrooms (number input)
- Flow per bedroom (number input, typically 150 gpd)
- Total design flow (number input or calculated)
- Other flow sources (text)
- Total system design flow (number input)
- Actual daily flow if metered (number input, optional)
- Use `<Input type="number">` for numeric fields with appropriate step/min values
- Consider showing a calculated total (`bedrooms * flowPerBedroom`) as helper text, but let the user override

**4. `src/components/inspection/step-septic-tank.tsx`** -- Step 4: Septic Tank Inspection
- Number of tanks (number input, default 1)
- For each tank (array rendering based on numberOfTanks):
  - Manufacturer, capacity, material (dropdown), liquid depth, scum thickness, sludge depth
  - Inlet/outlet condition (dropdown: Satisfactory/Unsatisfactory/N/A)
  - Baffles condition, risers condition
- **Tank condition checkboxes as large tap-friendly toggle rows per CONTEXT.md:**
  - Render each condition item (cracks, corrosion, leaking, structural damage, etc.) as a wide row with:
    - Label text on the left
    - Checkbox (or Switch) on the right
    - Entire row clickable (`min-h-[56px]`, `rounded-lg border p-4`, `flex items-center justify-between`)
    - Easy to tap with gloves or dirty hands -- big touch targets, no precision required
  - Use `FormField` with `Checkbox` (checked/onChange) for each boolean condition field
- Use `useFieldArray` from react-hook-form if implementing dynamic tank count, OR use a simpler approach: render fields based on `form.watch("septicTank.numberOfTanks")` value with a max of 3 tanks

**5. `src/components/inspection/step-disposal-works.tsx`** -- Step 5: Disposal Works
- Disposal type (dropdown: Conventional Trench, Bed, Chamber, Mound, Drip, Other)
- Number of lines/sections (number)
- Condition items (distribution box, dosing chamber, pump, timer, effluent quality, soil conditions, vegetation) -- each with condition dropdown (Satisfactory/Unsatisfactory/N/A)
- Additional findings (`<Textarea>` with generous height)
- Inspector summary (`<Textarea>`)
- Inspector recommendations (`<Textarea>`)
- Signature date (`<Input type="date">`)
- **No separate Submit button here** -- the WizardNavigation component handles showing Submit on the last step

**Mobile-first design rules for ALL steps:**
- Inputs: `min-h-[48px]` to prevent tiny tap targets
- Labels: `text-base` (not text-sm) for readability outdoors / in sunlight
- Spacing: `space-y-6` between field groups, `gap-4` within groups
- Textareas: at least 4 rows for summary/recommendations fields
- Selects: use the shadcn Select component which renders as a native-feeling dropdown
  </action>
  <verify>
    <automated>cd "/Users/danielendres/Documents/Dans Stuff/Inspection Form Filler" && npm run build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - All 5 step components render their ADEQ form fields correctly
    - Step 2 has a toggle switch that hides/shows alternative treatment system fields (FORM-02)
    - Step 4 has large tap-friendly toggle rows for tank condition checkboxes
    - All fields use `useFormContext()` to connect to the parent wizard form
    - Dropdowns use constants from `@/lib/constants/inspection`
    - Mobile-first layout: single column on small screens, 2 columns on larger
    - All interactive elements have minimum 44-48px touch targets
    - `npm run build` passes
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. Navigate to `/inspections/new` -- creates a draft and redirects to `/inspections/[id]/edit`
3. Wizard loads with Step 1 visible, inspector info pre-filled
4. Can navigate forward/backward through all 5 steps
5. Progress dots update to show current position
6. Fields validate on blur and highlight on Next (warn-but-allow -- navigation NOT blocked)
7. Closing browser and reopening `/inspections/[id]/edit` restores all entered data (auto-save worked)
8. Step 2 alternative system fields are hidden by default, visible after toggle
9. Step 4 condition checkboxes are large tap-friendly rows
10. Submit button appears only on Step 5
</verification>

<success_criteria>
- Complete 5-step wizard matching ADEQ GWS 432 form structure
- Auto-save on field blur with debounce, data persists across browser sessions (FORM-03)
- Inspector info pre-filled from profile + company defaults (FORM-04)
- Alternative system fields collapsed behind toggle (FORM-02)
- Mobile-first with 48px+ touch targets throughout
- Warn-but-allow validation on step navigation
- All validation enforced on final Submit
- Build and TypeScript compile pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-inspection-form-input/02-02-SUMMARY.md`
</output>
