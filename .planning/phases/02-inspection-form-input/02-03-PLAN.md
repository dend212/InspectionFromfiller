---
phase: 02-inspection-form-input
plan: 03
type: execute
wave: 3
depends_on: [02-02]
files_modified:
  - src/components/inspection/photo-capture.tsx
  - src/components/inspection/video-upload.tsx
  - src/components/inspection/media-gallery.tsx
  - src/app/api/inspections/[id]/media/route.ts
  - src/lib/db/migrations/0003_storage_bucket_setup.sql
  - src/components/inspection/step-facility-info.tsx
  - src/components/inspection/step-general-treatment.tsx
  - src/components/inspection/step-design-flow.tsx
  - src/components/inspection/step-septic-tank.tsx
  - src/components/inspection/step-disposal-works.tsx
autonomous: false
requirements: [MDIA-01, MDIA-02]
user_setup:
  - service: supabase-storage
    why: "Media uploads require a Supabase Storage bucket with RLS policies"
    dashboard_config:
      - task: "Run the storage bucket SQL migration in Supabase SQL Editor"
        location: "Supabase Dashboard -> SQL Editor -> paste 0003_storage_bucket_setup.sql"

must_haves:
  truths:
    - "Field tech can tap 'Add Photo' on any form section to capture a photo from device camera or select from gallery"
    - "Photos appear in a gallery below the photo button with thumbnail previews and optional captions"
    - "Field tech can upload a video file attached to the inspection"
    - "Videos over 120 seconds are rejected with a clear error message"
    - "Photos and videos are stored in Supabase Storage and metadata is recorded in the inspection_media table"
    - "Each form section has its own photo attachment area (per-section photos)"
    - "Uploaded media persists -- reloading the page shows previously uploaded photos/videos"
  artifacts:
    - path: "src/components/inspection/photo-capture.tsx"
      provides: "Photo capture button with native camera/gallery picker"
      min_lines: 40
    - path: "src/components/inspection/video-upload.tsx"
      provides: "Video upload with 120-second duration validation"
      min_lines: 40
    - path: "src/components/inspection/media-gallery.tsx"
      provides: "Gallery grid showing uploaded photos/videos with captions and delete"
      min_lines: 50
    - path: "src/app/api/inspections/[id]/media/route.ts"
      provides: "Media metadata CRUD (POST create, GET list, DELETE remove)"
      exports: ["POST", "GET", "DELETE"]
    - path: "src/lib/db/migrations/0003_storage_bucket_setup.sql"
      provides: "SQL to create inspection-media bucket and RLS policies"
  key_links:
    - from: "src/components/inspection/photo-capture.tsx"
      to: "supabase.storage"
      via: "Direct browser upload to Supabase Storage bucket"
      pattern: "supabase\\.storage\\.from.*upload"
    - from: "src/components/inspection/photo-capture.tsx"
      to: "src/app/api/inspections/[id]/media/route.ts"
      via: "POST to save media metadata after upload"
      pattern: "fetch.*media"
    - from: "src/components/inspection/media-gallery.tsx"
      to: "supabase.storage"
      via: "getPublicUrl or createSignedUrl for thumbnail display"
      pattern: "getPublicUrl|createSignedUrl"
    - from: "src/components/inspection/step-facility-info.tsx"
      to: "src/components/inspection/photo-capture.tsx"
      via: "Renders PhotoCapture component with section='facility-info'"
      pattern: "PhotoCapture.*section"
---

<objective>
Add photo capture from device camera, video upload with duration validation, and per-section media galleries to the inspection wizard. Set up Supabase Storage bucket and RLS policies for authenticated media uploads.

Purpose: Field techs need to document inspection findings with photos (cracks, damage, condition) and occasionally video. Photos are attached per-section so they're organized by what they document. Videos are capped at 120 seconds per CONTEXT.md.

Output: Photo capture component, video upload component, media gallery, media API route, storage bucket SQL migration, updated step components with photo areas.
</objective>

<execution_context>
@/Users/danielendres/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danielendres/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-inspection-form-input/02-RESEARCH.md
@.planning/phases/02-inspection-form-input/02-02-SUMMARY.md

<interfaces>
<!-- Contracts from Plan 02-01 and 02-02 that this plan builds against -->

From src/lib/db/schema.ts:
```typescript
export const inspectionMedia = pgTable("inspection_media", {
  id: uuid("id").defaultRandom().primaryKey(),
  inspectionId: uuid("inspection_id").references(() => inspections.id, { onDelete: "cascade" }).notNull(),
  type: text("type").notNull(), // 'photo' or 'video'
  storagePath: text("storage_path").notNull(),
  label: text("label"), // section identifier or descriptive caption
  sortOrder: integer("sort_order").default(0),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});
```

From src/lib/supabase/client.ts (browser):
```typescript
export function createClient(): SupabaseClient;
// Usage: supabase.storage.from('inspection-media').upload(path, file)
```

From src/lib/supabase/server.ts:
```typescript
export async function createClient(): Promise<SupabaseClient>;
```

From src/lib/db/index.ts:
```typescript
export const db: DrizzleInstance;
```

From src/components/inspection/ (created in 02-02):
```typescript
// Each step component uses useFormContext() and renders form fields
// Steps: step-facility-info.tsx, step-general-treatment.tsx, step-design-flow.tsx,
//        step-septic-tank.tsx, step-disposal-works.tsx
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build photo capture, video upload, media gallery components, and media API route</name>
  <files>
    src/components/inspection/photo-capture.tsx
    src/components/inspection/video-upload.tsx
    src/components/inspection/media-gallery.tsx
    src/app/api/inspections/[id]/media/route.ts
    src/lib/db/migrations/0003_storage_bucket_setup.sql
  </files>
  <action>
**1. `src/lib/db/migrations/0003_storage_bucket_setup.sql`** -- Supabase Storage bucket setup:
```sql
-- Create the inspection-media storage bucket (private, not public)
INSERT INTO storage.buckets (id, name, public, file_size_limit)
VALUES ('inspection-media', 'inspection-media', false, 209715200)
ON CONFLICT (id) DO NOTHING;
-- 209715200 bytes = 200MB (accommodates large videos)

-- Allow authenticated users to upload to inspection-media bucket
CREATE POLICY "Authenticated users can upload inspection media"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'inspection-media');

-- Allow authenticated users to view inspection media
CREATE POLICY "Authenticated users can view inspection media"
ON storage.objects FOR SELECT
TO authenticated
USING (bucket_id = 'inspection-media');

-- Allow authenticated users to delete inspection media
CREATE POLICY "Authenticated users can delete inspection media"
ON storage.objects FOR DELETE
TO authenticated
USING (bucket_id = 'inspection-media');
```
This SQL must be run manually in the Supabase Dashboard SQL Editor (same pattern as 0001 migration).

**2. `src/app/api/inspections/[id]/media/route.ts`** -- Media metadata CRUD:

**POST handler (record media metadata):**
- Authenticate user via `createClient()` from server + `getUser()`
- Return 401 if not authenticated
- Extract `id` from params (Next.js 16 async params: `const { id } = await params;`)
- Parse request body: `{ storagePath: string, type: 'photo' | 'video', label?: string, caption?: string }`
- Insert into `inspectionMedia` table via Drizzle: `{ inspectionId: id, type, storagePath, label }`
- Return 201 with the new media record

**GET handler (list media for inspection):**
- Authenticate user
- Select all `inspectionMedia` where `inspectionId = id`, ordered by `sortOrder asc, createdAt asc`
- Return JSON array

**DELETE handler (remove media):**
- Authenticate user
- Parse request body: `{ mediaId: string }`
- Select the media record to get `storagePath`
- Delete from Supabase Storage: `supabase.storage.from('inspection-media').remove([storagePath])`
- Delete from `inspectionMedia` table via Drizzle
- Return 200 with `{ deleted: true }`

**3. `src/components/inspection/photo-capture.tsx`** -- Photo capture/upload:
- `"use client"` directive
- Props: `inspectionId: string`, `section: string`, `onUploadComplete: (media: MediaRecord) => void`
- Render a styled `<label>` that looks like a button (min-h-[48px], primary colors) with text "Add Photo" and a Camera icon from lucide-react
- Hidden `<input type="file" accept="image/*" capture="environment">` triggered by the label
- On file select:
  1. Show loading state (spinner or "Uploading...")
  2. Generate file path: `${inspectionId}/${section}/${crypto.randomUUID()}-${file.name}`
  3. Upload to Supabase Storage: `createClient().storage.from('inspection-media').upload(filePath, file)`
  4. On upload success: POST to `/api/inspections/${inspectionId}/media` with `{ storagePath: data.path, type: 'photo', label: section }`
  5. Call `onUploadComplete(mediaRecord)` to update parent state
  6. On error: show toast via sonner
- Handle upload progress if possible (Supabase SDK may not expose granular progress)

**4. `src/components/inspection/video-upload.tsx`** -- Video upload with duration validation:
- `"use client"` directive
- Props: `inspectionId: string`, `onUploadComplete: (media: MediaRecord) => void`
- Render a styled button "Upload Video" with a Video icon from lucide-react
- Hidden `<input type="file" accept="video/*">`
- On file select:
  1. **Duration validation (MDIA-02):** Create a temporary `<video>` element, set `src = URL.createObjectURL(file)`, wait for `loadedmetadata` event, read `video.duration`. If `duration > 120`, show `toast.error("Video must be 120 seconds or less")` and reject. Clean up with `URL.revokeObjectURL()`.
  2. If valid: upload to Supabase Storage at path `${inspectionId}/video/${crypto.randomUUID()}-${file.name}`
  3. POST metadata to API with `type: 'video'`
  4. Call `onUploadComplete(mediaRecord)`
- Show upload progress or loading state during upload (videos can be large)

**5. `src/components/inspection/media-gallery.tsx`** -- Display uploaded media:
- `"use client"` directive
- Props: `inspectionId: string`, `section?: string`, `media: MediaRecord[]`, `onDelete: (mediaId: string) => void`
- Render a grid of media items (2 columns on mobile, 3 on desktop)
- For each photo: show a thumbnail using Supabase Storage URL (use `supabase.storage.from('inspection-media').getPublicUrl(storagePath)` -- but since bucket is private, use `createSignedUrl(storagePath, 3600)` for 1-hour signed URLs instead)
- For each video: show a video icon placeholder with file name (don't try to thumbnail videos)
- Each item shows:
  - Thumbnail or placeholder
  - Optional caption (editable text input below -- this is the optional photo caption from CONTEXT.md)
  - Delete button (X icon, calls `onDelete(mediaId)`)
- Caption editing: on blur, POST/PATCH to update the media record's label field
- Empty state: subtle dashed border area with "No photos yet" text

Define a `MediaRecord` type (or import from types):
```typescript
interface MediaRecord {
  id: string;
  type: 'photo' | 'video';
  storagePath: string;
  label: string | null;
  caption?: string;
  createdAt: string;
}
```
  </action>
  <verify>
    <automated>cd "/Users/danielendres/Documents/Dans Stuff/Inspection Form Filler" && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - PhotoCapture triggers native camera/gallery picker via `<input capture="environment">`
    - Photo uploads to Supabase Storage and metadata saved to inspection_media table
    - VideoUpload validates duration <= 120 seconds before uploading
    - MediaGallery shows thumbnails with signed URLs, captions, and delete buttons
    - Media API route handles POST (create), GET (list), DELETE (remove)
    - Storage bucket SQL migration ready for manual application
    - TypeScript compiles with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate photo capture and media gallery into all 5 wizard step components</name>
  <files>
    src/components/inspection/step-facility-info.tsx
    src/components/inspection/step-general-treatment.tsx
    src/components/inspection/step-design-flow.tsx
    src/components/inspection/step-septic-tank.tsx
    src/components/inspection/step-disposal-works.tsx
  </files>
  <action>
**Add per-section photo areas to each step component (CONTEXT.md: "Per-section photo attachment: each form section has its own 'Add Photo' area").**

For each of the 5 step components, add at the bottom of the step (after all form fields):

1. Import `PhotoCapture` from `./photo-capture` and `MediaGallery` from `./media-gallery`
2. Accept `inspectionId: string` as a prop (passed from the wizard shell)
3. Add state: `const [media, setMedia] = useState<MediaRecord[]>([])` and a `useEffect` that fetches media on mount: `GET /api/inspections/${inspectionId}/media?section=${sectionName}`
4. Render a section at the bottom:
```tsx
<Separator className="my-6" />
<div className="space-y-4">
  <h3 className="text-base font-medium">Photos</h3>
  <MediaGallery
    inspectionId={inspectionId}
    section={sectionName}
    media={media.filter(m => m.label === sectionName && m.type === 'photo')}
    onDelete={handleDeleteMedia}
  />
  <PhotoCapture
    inspectionId={inspectionId}
    section={sectionName}
    onUploadComplete={(newMedia) => setMedia(prev => [...prev, newMedia])}
  />
</div>
```

Section names for the `section` prop:
- Step 1: `"facility-info"`
- Step 2: `"general-treatment"`
- Step 3: `"design-flow"`
- Step 4: `"septic-tank"`
- Step 5: `"disposal-works"`

**Video upload (only on Step 5 or a general area):**
Add `VideoUpload` to Step 5 (Disposal Works) below the photo area, since video is a general inspection attachment rather than section-specific:
```tsx
<div className="space-y-4">
  <h3 className="text-base font-medium">Video</h3>
  <VideoUpload
    inspectionId={inspectionId}
    onUploadComplete={(newMedia) => setMedia(prev => [...prev, newMedia])}
  />
  <MediaGallery
    inspectionId={inspectionId}
    media={media.filter(m => m.type === 'video')}
    onDelete={handleDeleteMedia}
  />
</div>
```

**The `handleDeleteMedia` function:**
```typescript
const handleDeleteMedia = async (mediaId: string) => {
  await fetch(`/api/inspections/${inspectionId}/media`, {
    method: "DELETE",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mediaId }),
  });
  setMedia(prev => prev.filter(m => m.id !== mediaId));
};
```

**Update the InspectionWizard** to pass `inspectionId` to each step component:
The wizard shell (`inspection-wizard.tsx`) already has `inspection.id`. Pass it as a prop:
```tsx
{currentStep === 0 && <StepFacilityInfo inspectionId={inspection.id} />}
{currentStep === 1 && <StepGeneralTreatment inspectionId={inspection.id} />}
// ... etc
```
Note: You may need to also update `inspection-wizard.tsx` to pass this prop -- that file is from Plan 02-02 and is NOT in this plan's exclusive files. The executor should make this minimal addition (adding the `inspectionId` prop pass-through) to `inspection-wizard.tsx` even though it's not listed in `files_modified` -- this is a wiring change, not a rewrite.
  </action>
  <verify>
    <automated>cd "/Users/danielendres/Documents/Dans Stuff/Inspection Form Filler" && npm run build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - Each of the 5 step components has a "Photos" section with PhotoCapture and MediaGallery
    - Step 5 additionally has a "Video" section with VideoUpload
    - Photos are filtered by section label (per-section attachment)
    - Upload, display, and delete work end-to-end
    - `npm run build` passes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Supabase Storage bucket and end-to-end media upload</name>
  <files>src/lib/db/migrations/0003_storage_bucket_setup.sql</files>
  <action>
User must apply the storage bucket migration and verify the complete Phase 2 experience end-to-end.

**What was built:** Complete inspection form wizard with photo capture, video upload, per-section media galleries, auto-save, and all 5 ADEQ form sections. Supabase Storage bucket SQL migration created but needs manual application.

**How to verify:**
1. **Apply storage migration:** Go to Supabase Dashboard -> SQL Editor -> paste contents of `src/lib/db/migrations/0003_storage_bucket_setup.sql` -> Run
2. **Create a new inspection:** Navigate to the app -> click "New Inspection" -> verify redirect to wizard
3. **Check pre-filled fields:** Step 1 should show inspector name, "SewerTime Septic", "NAWT #15805", "CR-37", "ADEQ Truck #2833" pre-filled
4. **Navigate all 5 steps:** Use Next/Back buttons and progress dots to move through all sections
5. **Test auto-save:** Enter some data, close the browser tab, reopen the same inspection URL -- data should be restored
6. **Test photo capture on mobile (or desktop):** On Step 4 (Septic Tank), tap "Add Photo" -- camera or file picker should open. Select a photo. It should appear in the gallery with a thumbnail.
7. **Test video upload:** On Step 5 (Disposal Works), upload a video under 120 seconds -- should succeed. Try a video over 120 seconds -- should show error toast.
8. **Test photo caption:** Click below a photo thumbnail to add a caption like "Crack in tank lid" -- it should save.
9. **Test photo delete:** Click the X on a photo -- it should disappear.
10. **Test toggle (Step 2):** The "Alternative Treatment System" toggle should be OFF by default with fields hidden. Toggle ON to see the extra fields.
  </action>
  <verify>User confirms all 10 verification steps pass</verify>
  <done>All Phase 2 features verified working: form wizard, auto-save, pre-fill, conditional toggles, photo capture, video upload, media management</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. Storage bucket SQL migration creates `inspection-media` bucket with correct RLS policies
3. Photo capture opens native camera or gallery picker on mobile
4. Photos upload to Supabase Storage and appear in per-section galleries
5. Video upload validates 120-second duration limit
6. Media metadata persists in `inspection_media` table
7. Deleting media removes both the storage file and the database record
8. Media persists across page reloads (fetched from API on mount)
</verification>

<success_criteria>
- Field tech can capture photos from device camera on any form section (MDIA-01)
- Photos are per-section with thumbnails, optional captions, and delete capability
- Video upload with 120-second limit enforced client-side (MDIA-02)
- Media stored in Supabase Storage, metadata in inspection_media table
- All media persists and displays correctly after page reload
- End-to-end flow verified by user on device
</success_criteria>

<output>
After completion, create `.planning/phases/02-inspection-form-input/02-03-SUMMARY.md`
</output>
