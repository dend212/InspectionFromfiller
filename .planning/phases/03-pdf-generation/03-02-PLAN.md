---
phase: 03-pdf-generation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/pdf/generate-report.ts
  - src/components/inspection/signature-pad.tsx
  - src/components/inspection/pdf-preview.tsx
  - src/components/inspection/generate-pdf-button.tsx
  - src/hooks/use-pdf-generation.ts
  - src/app/(dashboard)/inspections/[id]/page.tsx
autonomous: true
requirements: [PDF-01, PDF-02]

must_haves:
  truths:
    - "User can draw a signature on screen using finger or stylus and see it rendered on the pad"
    - "User can clear the signature pad and redraw"
    - "User can click 'Generate PDF' on the inspection detail page and see a loading state while generation runs"
    - "Generated PDF displays in an in-browser preview using an embedded iframe viewer"
    - "User can download the generated PDF file"
    - "PDF can be re-generated anytime after edits (always reflects latest data)"
    - "Signature date auto-fills to today's date"
  artifacts:
    - path: "src/lib/pdf/generate-report.ts"
      provides: "Orchestrator that loads template, maps data, embeds signature, calls pdfme generate()"
      exports: ["generateReport"]
    - path: "src/components/inspection/signature-pad.tsx"
      provides: "react-signature-canvas wrapper with clear button and PNG data URL export"
      exports: ["SignaturePad"]
    - path: "src/components/inspection/pdf-preview.tsx"
      provides: "In-browser PDF viewer using iframe with Blob URL"
      exports: ["PdfPreview"]
    - path: "src/components/inspection/generate-pdf-button.tsx"
      provides: "Generate PDF button with loading spinner, wired to use-pdf-generation hook"
      exports: ["GeneratePdfButton"]
    - path: "src/hooks/use-pdf-generation.ts"
      provides: "React hook managing PDF generation state (loading, error, pdfData)"
      exports: ["usePdfGeneration"]
    - path: "src/app/(dashboard)/inspections/[id]/page.tsx"
      provides: "Inspection detail page with signature pad, generate button, and PDF preview"
  key_links:
    - from: "src/lib/pdf/generate-report.ts"
      to: "src/lib/pdf/template.ts"
      via: "imports loadTemplate() to get basePdf and font data"
      pattern: "import.*loadTemplate.*from.*template"
    - from: "src/lib/pdf/generate-report.ts"
      to: "src/lib/pdf/field-mapping.ts"
      via: "imports mapFormDataToInputs() to convert form data"
      pattern: "import.*mapFormDataToInputs.*from.*field-mapping"
    - from: "src/hooks/use-pdf-generation.ts"
      to: "src/lib/pdf/generate-report.ts"
      via: "calls generateReport() and manages the Uint8Array result as state"
      pattern: "import.*generateReport"
    - from: "src/components/inspection/generate-pdf-button.tsx"
      to: "src/hooks/use-pdf-generation.ts"
      via: "uses usePdfGeneration hook for state and trigger"
      pattern: "usePdfGeneration"
---

<objective>
Build the PDF generation pipeline and UI components: signature capture pad, generate button with loading state, in-browser PDF preview, and the inspection detail page that ties them together.

Purpose: This is the user-facing PDF generation experience. The field tech or office staff opens an inspection, draws a signature, clicks "Generate PDF", and previews the result in-browser before downloading.

Output: `generate-report.ts` (orchestrator), `signature-pad.tsx`, `pdf-preview.tsx`, `generate-pdf-button.tsx`, `use-pdf-generation.ts` (hook), inspection detail page.
</objective>

<execution_context>
@/Users/danielendres/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danielendres/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pdf-generation/03-RESEARCH.md
@.planning/phases/03-pdf-generation/03-01-SUMMARY.md
@src/lib/pdf/template.ts
@src/lib/pdf/field-mapping.ts
@src/types/inspection.ts
@src/lib/db/schema.ts
@src/app/(dashboard)/inspections/[id]/edit/page.tsx

<interfaces>
<!-- From Plan 01 outputs (template and field-mapping modules) -->

From src/lib/pdf/template.ts:
```typescript
export async function loadTemplate(): Promise<{
  template: Template;
  font: Record<string, { data: ArrayBuffer; fallback?: boolean }>;
}>;
export const ADEQ_TEMPLATE_SCHEMAS: Schema[][];
```

From src/lib/pdf/field-mapping.ts:
```typescript
export function mapFormDataToInputs(data: InspectionFormData): Record<string, string>;
export function detectCommentOverflow(data: InspectionFormData): {
  hasOverflow: boolean;
  overflowSections: Array<{ section: string; fieldName: string; text: string }>;
};
```

From src/components/inspection/media-gallery.tsx:
```typescript
export interface MediaRecord {
  id: string;
  type: "photo" | "video";
  storagePath: string;
  label: string | null;
  sortOrder: number | null;
  createdAt: string;
}
```

pdfme generate API:
```typescript
import { generate } from '@pdfme/generator';
const pdf: Uint8Array = await generate({ template, inputs: [inputRecord], plugins, options: { font } });
```

react-signature-canvas API:
```typescript
import SignatureCanvas from 'react-signature-canvas';
// ref.current.toDataURL('image/png') -> string
// ref.current.getTrimmedCanvas() -> HTMLCanvasElement
// ref.current.clear() -> void
// ref.current.isEmpty() -> boolean
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-signature-canvas and create PDF generation orchestrator + hook</name>
  <files>
    package.json
    src/lib/pdf/generate-report.ts
    src/hooks/use-pdf-generation.ts
  </files>
  <action>
1. Install react-signature-canvas:
   ```bash
   npm install react-signature-canvas
   npm install --save-dev @types/react-signature-canvas
   ```

2. **generate-report.ts**: Create the PDF generation orchestrator function.

   ```typescript
   export async function generateReport(
     formData: InspectionFormData,
     signatureDataUrl: string | null
   ): Promise<Uint8Array>
   ```

   Implementation:
   - Call `loadTemplate()` to get the template (with basePdf) and font data
   - Call `mapFormDataToInputs(formData)` to get the flat inputs record
   - If `signatureDataUrl` is provided, add it to inputs as `signatureImage`
   - Auto-fill signature date to today's date formatted as MM/DD/YYYY in the inputs
   - Import plugins: `import { text, image } from '@pdfme/schemas'`
   - Call `generate({ template, inputs: [inputs], plugins: { text, image }, options: { font } })`
   - Return the resulting Uint8Array

   Per user decision: signature date auto-fills to today's date. Fresh signature each inspection. Client-side generation using pdfme in the browser.

   **NOTE:** This initial version generates ONLY the form pages (6-page ADEQ form with data overlay). Photo pages and comments overflow pages are handled by Plan 03, which will extend this function or provide a separate merge step.

3. **use-pdf-generation.ts**: Create the React hook for managing PDF generation state.

   ```typescript
   export function usePdfGeneration() {
     // Returns: { generatePdf, pdfData, isGenerating, error, clearPdf }
   }
   ```

   Implementation:
   - `pdfData: Uint8Array | null` state
   - `isGenerating: boolean` state
   - `error: string | null` state
   - `generatePdf(formData: InspectionFormData, signatureDataUrl: string | null): Promise<void>` -- calls generateReport, sets pdfData on success, sets error on failure
   - `clearPdf()` -- resets pdfData to null (for re-generation after edits)
   - Handle errors gracefully: catch exceptions from generate(), set error message, log to console

   Per user decision: loading states during PDF generation. Error handling for generation failures.
  </action>
  <verify>
    <automated>cd "$(pwd)" && npx tsc --noEmit src/lib/pdf/generate-report.ts src/hooks/use-pdf-generation.ts 2>&1 | head -30</automated>
  </verify>
  <done>
  - generate-report.ts exports generateReport() that loads template, maps data, embeds signature, generates PDF
  - use-pdf-generation.ts exports hook with generatePdf, pdfData, isGenerating, error, clearPdf
  - Signature date auto-fills to today
  - react-signature-canvas package installed
  </done>
</task>

<task type="auto">
  <name>Task 2: Create signature pad, PDF preview, generate button, and inspection detail page</name>
  <files>
    src/components/inspection/signature-pad.tsx
    src/components/inspection/pdf-preview.tsx
    src/components/inspection/generate-pdf-button.tsx
    src/app/(dashboard)/inspections/[id]/page.tsx
  </files>
  <action>
1. **signature-pad.tsx**: Create the signature capture component.

   Props: `onSignatureCapture: (dataUrl: string) => void`

   Implementation:
   - Use `react-signature-canvas` with `useRef<SignatureCanvas>(null)`
   - Canvas wrapper with dashed border, rounded corners, full-width, height 160px (h-40)
   - `penColor="black"`, `backgroundColor="rgba(0,0,0,0)"` (transparent for PNG export)
   - `canvasProps={{ className: 'w-full h-40 touch-none' }}` -- touch-none prevents scroll on mobile while drawing
   - `onEnd` handler: check `!sigRef.current.isEmpty()`, get trimmed canvas via `getTrimmedCanvas()`, call `toDataURL('image/png')`, pass to `onSignatureCapture`
   - Clear button: calls `sigRef.current.clear()` and resets isEmpty state
   - Label: "Inspector Signature" above the pad
   - Show "Signature required" hint text below when empty

   Per user decision: draw-on-screen signature pad (finger/stylus). No typed or uploaded signatures. Fresh signature each inspection.

2. **pdf-preview.tsx**: Create the in-browser PDF preview component.

   Props: `pdfData: Uint8Array | null`

   Implementation:
   - When pdfData changes, create `new Blob([pdfData], { type: 'application/pdf' })`, then `URL.createObjectURL(blob)`
   - Display in `<iframe src={blobUrl} className="w-full h-[80vh] rounded-lg border" title="PDF Preview" />`
   - Cleanup: `URL.revokeObjectURL(url)` in useEffect return
   - Show nothing when pdfData is null
   - Add a download button below the iframe that creates an `<a>` element with `href={blobUrl}` and `download="ADEQ-Inspection-{facilityName}.pdf"`

   Per user decision: in-browser PDF preview before download. Embedded viewer.

3. **generate-pdf-button.tsx**: Create the generate button component.

   Props: `onGenerate: () => Promise<void>`, `isGenerating: boolean`, `error: string | null`

   Implementation:
   - Primary button: "Generate PDF" with file icon (lucide-react FileText)
   - While generating: show spinner icon + "Generating PDF..." text, button disabled
   - If error: show error message in red text below button
   - Use shadcn/ui Button component with variant="default" and size="lg"

4. **Inspection detail page** at `src/app/(dashboard)/inspections/[id]/page.tsx`:

   This is a NEW page (currently only the edit page exists at `.../[id]/edit/page.tsx`). This page shows inspection details, the signature pad, and the PDF generation UI.

   Implementation (server component with client island):
   - Server component: load inspection from DB using same pattern as edit page (Drizzle query, ownership/role check)
   - Also load media records for this inspection (for display and future photo page generation)
   - Pass data to a client component `InspectionPdfView`

   **InspectionPdfView** client component (can be inline in the same file or a separate component):
   - Display inspection summary header: facility name, address, date, status badge
   - "Edit Inspection" link back to `.../[id]/edit`
   - Signature pad section: `<SignaturePad>` with state for `signatureDataUrl`
   - "Generate PDF" button using `<GeneratePdfButton>` wired to `usePdfGeneration` hook
   - The generate handler calls `generatePdf(formData, signatureDataUrl)`
   - Below the button: `<PdfPreview pdfData={pdfData} />` when a PDF has been generated
   - If PDF already generated and user edits, show "Data has changed. Re-generate PDF to see updates." hint

   Per user decision: "Generate PDF" button on the inspection detail page (not auto-generated). PDF can be re-generated anytime after edits. In-browser preview before download.

   Route pattern: follows existing `(dashboard)/inspections/[id]/edit/page.tsx` for auth/ownership checks.
  </action>
  <verify>
    <automated>cd "$(pwd)" && npx tsc --noEmit src/components/inspection/signature-pad.tsx src/components/inspection/pdf-preview.tsx src/components/inspection/generate-pdf-button.tsx src/app/\(dashboard\)/inspections/\[id\]/page.tsx 2>&1 | head -30</automated>
  </verify>
  <done>
  - SignaturePad renders canvas, captures PNG data URL on draw end, has clear button
  - PdfPreview shows generated PDF in iframe with Blob URL, has download button
  - GeneratePdfButton shows loading state during generation, displays errors
  - Inspection detail page loads inspection data, shows signature pad, generate button, and preview
  - All components use 'use client' directive
  - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for all new files
2. Inspection detail page at `/inspections/[id]` renders without errors
3. SignaturePad captures signature and exports PNG data URL
4. GeneratePdfButton triggers PDF generation and shows loading state
5. PdfPreview displays generated PDF in embedded iframe
6. Download button creates downloadable PDF file
7. Signature date auto-fills to current date
8. Re-generation works (clicking generate again produces fresh PDF with latest data)
</verification>

<success_criteria>
- Complete PDF generation flow: load inspection -> draw signature -> click generate -> see preview -> download
- Signature pad works on touch devices (finger/stylus) and mouse
- Loading state visible during generation
- Error handling displays user-friendly messages
- Generated PDF opens correctly in browser's built-in PDF viewer
- Re-generation reflects latest form data changes
</success_criteria>

<output>
After completion, create `.planning/phases/03-pdf-generation/03-02-SUMMARY.md`
</output>
