---
phase: 04-review-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - src/lib/db/migrations/0004_review_workflow.sql
  - src/app/api/inspections/[id]/submit/route.ts
  - src/app/api/inspections/[id]/return/route.ts
  - src/app/api/inspections/[id]/finalize/route.ts
  - src/app/api/inspections/[id]/reopen/route.ts
  - src/app/api/inspections/[id]/route.ts
  - src/components/inspection/submit-for-review-button.tsx
  - src/components/inspection/inspection-wizard.tsx
  - src/components/inspection/wizard-navigation.tsx
  - src/components/inspection/review-note-banner.tsx
  - src/app/(dashboard)/inspections/[id]/edit/page.tsx
  - src/components/ui/alert-dialog.tsx
autonomous: true
requirements:
  - WKFL-01

user_setup:
  - service: supabase
    why: "Database migration must be applied via Supabase SQL Editor"
    dashboard_config:
      - task: "Run migration 0004_review_workflow.sql in SQL Editor"
        location: "Supabase Dashboard -> SQL Editor -> paste and run"

must_haves:
  truths:
    - "Field tech can submit a completed inspection, changing its status from draft to in_review"
    - "Only draft inspections can be submitted (status guard prevents double-submit)"
    - "Field techs cannot edit inspections that are in_review or completed via the PATCH API"
    - "Admin can return an in_review inspection to draft with a note"
    - "Admin can finalize an in_review inspection to completed"
    - "Admin can reopen a completed inspection back to in_review"
    - "Field tech sees a return note banner when reopening a returned draft"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "Updated inspections table with reviewNotes, finalizedPdfPath, reviewedBy columns; profiles with notificationSettings"
      contains: "reviewNotes"
    - path: "src/lib/db/migrations/0004_review_workflow.sql"
      provides: "SQL migration for new columns"
      contains: "ALTER TABLE"
    - path: "src/app/api/inspections/[id]/submit/route.ts"
      provides: "POST endpoint for draft -> in_review transition"
      exports: ["POST"]
    - path: "src/app/api/inspections/[id]/return/route.ts"
      provides: "POST endpoint for in_review -> draft transition with note"
      exports: ["POST"]
    - path: "src/app/api/inspections/[id]/finalize/route.ts"
      provides: "POST endpoint for in_review -> completed transition"
      exports: ["POST"]
    - path: "src/app/api/inspections/[id]/reopen/route.ts"
      provides: "POST endpoint for completed -> in_review transition"
      exports: ["POST"]
    - path: "src/components/inspection/submit-for-review-button.tsx"
      provides: "Submit for Review button with warn-but-allow confirmation dialog"
      contains: "Submit for Review"
  key_links:
    - from: "src/components/inspection/submit-for-review-button.tsx"
      to: "/api/inspections/[id]/submit"
      via: "fetch POST call"
      pattern: "fetch.*submit"
    - from: "src/app/api/inspections/[id]/submit/route.ts"
      to: "db.update(inspections)"
      via: "Drizzle atomic status transition"
      pattern: "eq.*inspections\\.status.*draft"
    - from: "src/app/api/inspections/[id]/route.ts"
      to: "inspections.status"
      via: "Status guard on PATCH for field techs"
      pattern: "status.*draft"
---

<objective>
Database migration for review workflow columns, all four status transition API endpoints (submit, return, finalize, reopen), "Submit for Review" button on the wizard, PATCH API status guard for field techs, and return-note banner on returned drafts.

Purpose: Establish the status state machine and submission flow so that field techs can submit inspections and the API enforces correct status transitions. This is the foundation for the review interface in Plan 04-02.

Output: Migration SQL, 4 new API routes, updated PATCH route, submit button component, review note banner component
</objective>

<execution_context>
@/Users/danielendres/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danielendres/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-review-workflow/04-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/lib/db/schema.ts:
```typescript
export const inspectionStatusEnum = pgEnum("inspection_status", [
  "draft", "submitted", "in_review", "completed", "sent",
]);

export const inspections = pgTable("inspections", {
  id: uuid("id").defaultRandom().primaryKey(),
  inspectorId: uuid("inspector_id").references(() => profiles.id).notNull(),
  status: inspectionStatusEnum("status").default("draft").notNull(),
  facilityName: text("facility_name"),
  facilityAddress: text("facility_address"),
  facilityCity: text("facility_city"),
  facilityCounty: text("facility_county"),
  facilityState: varchar("facility_state", { length: 2 }).default("AZ"),
  facilityZip: varchar("facility_zip", { length: 10 }),
  formData: jsonb("form_data"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
  submittedAt: timestamp("submitted_at"),
  completedAt: timestamp("completed_at"),
});

export const profiles = pgTable("profiles", {
  id: uuid("id").primaryKey(),
  fullName: text("full_name").notNull(),
  email: text("email").notNull(),
  phone: varchar("phone", { length: 20 }),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
});
```

From src/app/api/inspections/[id]/route.ts (PATCH pattern):
```typescript
// Existing PATCH handler: auth check, ownership/role check, then update formData + denormalized fields.
// No status check currently -- field tech can edit regardless of status.
// Must add: if field tech (not admin/office_staff), reject PATCH when status !== 'draft'.
```

From src/components/inspection/wizard-navigation.tsx:
```typescript
interface WizardNavigationProps {
  currentStep: number;
  onNext: () => void;
  onBack: () => void;
  isLastStep: boolean;
  isSubmitting: boolean;
  saving?: boolean;
  lastSaved?: Date | null;
}
```

From src/components/inspection/inspection-wizard.tsx:
```typescript
interface InspectionWizardProps {
  inspection: {
    id: string;
    formData: InspectionFormData | null;
    status: string;
  };
}
// Wizard uses: useForm, useAutoSave, currentStep state, handleNext/handleBack
```

From src/app/(dashboard)/inspections/[id]/edit/page.tsx:
```typescript
// Server component: loads inspection by ID, checks auth + ownership, renders InspectionWizard
// Currently passes: { id, formData, status }
```

From src/lib/validators/inspection.ts:
```typescript
export const inspectionFormSchema = z.object({ ... });
// safeParse() can be used for warn-but-allow validation
```

API route JWT role decode pattern (used in all existing API routes):
```typescript
const { data: { session } } = await supabase.auth.getSession();
const payload = JSON.parse(Buffer.from(session.access_token.split(".")[1], "base64").toString());
const userRole = payload.user_role ?? null;
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and Drizzle schema update for review workflow columns</name>
  <files>
    src/lib/db/schema.ts
    src/lib/db/migrations/0004_review_workflow.sql
  </files>
  <action>
**Migration SQL (0004_review_workflow.sql):**

Create the migration file with these ALTER TABLE statements:

```sql
-- Add review workflow columns to inspections table
ALTER TABLE public.inspections
  ADD COLUMN IF NOT EXISTS review_notes text,
  ADD COLUMN IF NOT EXISTS finalized_pdf_path text,
  ADD COLUMN IF NOT EXISTS reviewed_by uuid REFERENCES public.profiles(id);

-- Add notification settings to profiles table
ALTER TABLE public.profiles
  ADD COLUMN IF NOT EXISTS notification_settings jsonb DEFAULT '{"emailOnSubmission": false}'::jsonb;
```

No new RLS policies needed -- the existing row-level policies cover these new columns automatically (RLS is row-level, not column-level).

**Drizzle schema update (schema.ts):**

Add three new columns to the `inspections` table definition:
- `reviewNotes: text("review_notes")` -- stores the return note from admin
- `finalizedPdfPath: text("finalized_pdf_path")` -- storage path for the finalized PDF
- `reviewedBy: uuid("reviewed_by").references(() => profiles.id)` -- which admin reviewed it

Add one new column to the `profiles` table definition:
- `notificationSettings: jsonb("notification_settings").default({ emailOnSubmission: false })` -- notification preferences

Place `reviewNotes` and `finalizedPdfPath` and `reviewedBy` after `completedAt` in the inspections table. Place `notificationSettings` after `updatedAt` in the profiles table.
  </action>
  <verify>
    <automated>cd "/Users/danielendres/Documents/Dans Stuff/Inspection Form Filler" && npx drizzle-kit generate 2>&1 | head -20 && grep -c "reviewNotes\|finalizedPdfPath\|reviewedBy\|notificationSettings" src/lib/db/schema.ts</automated>
  </verify>
  <done>
    - schema.ts has reviewNotes, finalizedPdfPath, reviewedBy on inspections table
    - schema.ts has notificationSettings on profiles table
    - Migration file 0004_review_workflow.sql exists with ALTER TABLE statements
    - Drizzle schema is valid (no TypeScript errors)
  </done>
</task>

<task type="auto">
  <name>Task 2: Four status transition API endpoints with atomic guards</name>
  <files>
    src/app/api/inspections/[id]/submit/route.ts
    src/app/api/inspections/[id]/return/route.ts
    src/app/api/inspections/[id]/finalize/route.ts
    src/app/api/inspections/[id]/reopen/route.ts
    src/app/api/inspections/[id]/route.ts
  </files>
  <action>
**All four endpoints follow the same pattern:**
1. Extract `id` from `await params`
2. Auth check via `supabase.auth.getUser()`
3. Role check via JWT decode (same pattern as existing routes -- `Buffer.from(session.access_token.split(".")[1], "base64")`)
4. Atomic status transition: `db.update(inspections).set({...}).where(and(eq(inspections.id, id), eq(inspections.status, expectedCurrentStatus)))` -- if zero rows returned, return 409 Conflict
5. Return the new status in JSON response

**POST /api/inspections/[id]/submit/route.ts:**
- Guard: status must be `"draft"`, user must be inspector or admin
- Set: `status: "in_review"`, `submittedAt: new Date()`, `updatedAt: new Date()`
- WHERE clause includes: `eq(inspections.status, "draft")` AND (`eq(inspections.inspectorId, user.id)` OR user is admin)
- For admin case: do two separate checks -- first check ownership, if not owner then check role
- Return `{ status: "in_review" }`
- Do NOT send email notification here yet (Plan 04-02 adds that)

**POST /api/inspections/[id]/return/route.ts:**
- Guard: status must be `"in_review"`, user must be admin
- Parse body: `const { note } = await request.json()`
- Set: `status: "draft"`, `reviewNotes: note || null`, `submittedAt: null`, `updatedAt: new Date()`
- Return `{ status: "draft" }`

**POST /api/inspections/[id]/finalize/route.ts:**
- Guard: status must be `"in_review"`, user must be admin
- Parse body: `const { pdfPath } = await request.json()` (optional -- may be null if finalized without uploading)
- Set: `status: "completed"`, `completedAt: new Date()`, `finalizedPdfPath: pdfPath || null`, `reviewedBy: user.id`, `updatedAt: new Date()`
- Return `{ status: "completed" }`

**POST /api/inspections/[id]/reopen/route.ts:**
- Guard: status must be `"completed"`, user must be admin
- Set: `status: "in_review"`, `completedAt: null`, `updatedAt: new Date()`
- Return `{ status: "in_review" }`

**Modify PATCH /api/inspections/[id]/route.ts:**
Add a status check for field techs. After the existing ownership/role check block, before updating formData:

```typescript
// Field techs can only edit drafts (defense in depth -- RLS also enforces this)
if (!isPrivileged) {
  const [statusCheck] = await db
    .select({ status: inspections.status })
    .from(inspections)
    .where(eq(inspections.id, id))
    .limit(1);
  if (statusCheck && statusCheck.status !== "draft") {
    return NextResponse.json(
      { error: "Cannot edit: inspection is no longer a draft" },
      { status: 403 }
    );
  }
}
```

Place this check right after the `isPrivileged` determination (after the ownership/role check). Use the variable `isPrivileged` that already exists in the code path. Note: the existing PATCH already does two queries -- one for ownership check, then the update. Fold the status check into the existing first query by adding `status` to the select fields, avoiding an extra DB round-trip:

Instead of the separate query approach above, modify the existing ownership query to also select `status`:
```typescript
const [existing] = await db
  .select({ inspectorId: inspections.inspectorId, status: inspections.status })
  .from(inspections)
  .where(eq(inspections.id, id))
  .limit(1);
```

Then after the role check, add:
```typescript
if (!isPrivileged && existing.status !== "draft") {
  return NextResponse.json(
    { error: "Cannot edit: inspection is no longer a draft" },
    { status: 403 }
  );
}
```

Use these imports in all new route files:
```typescript
import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";
import { db } from "@/lib/db";
import { inspections } from "@/lib/db/schema";
import { eq, and } from "drizzle-orm";
```
  </action>
  <verify>
    <automated>cd "/Users/danielendres/Documents/Dans Stuff/Inspection Form Filler" && npx tsc --noEmit 2>&1 | tail -5 && ls src/app/api/inspections/\[id\]/submit/route.ts src/app/api/inspections/\[id\]/return/route.ts src/app/api/inspections/\[id\]/finalize/route.ts src/app/api/inspections/\[id\]/reopen/route.ts</automated>
  </verify>
  <done>
    - All 4 status transition routes exist and export POST
    - Each route uses atomic WHERE clause checking current status (prevents race conditions)
    - Submit allows inspector or admin; return/finalize/reopen require admin
    - PATCH route now rejects field tech edits on non-draft inspections
    - All routes return JSON with the new status or a 409/401/403 error
  </done>
</task>

<task type="auto">
  <name>Task 3: Submit for Review button on wizard with warn-but-allow dialog and return-note banner</name>
  <files>
    src/components/inspection/submit-for-review-button.tsx
    src/components/inspection/review-note-banner.tsx
    src/components/inspection/inspection-wizard.tsx
    src/components/inspection/wizard-navigation.tsx
    src/app/(dashboard)/inspections/[id]/edit/page.tsx
    src/components/ui/alert-dialog.tsx
  </files>
  <action>
**Install shadcn AlertDialog component:**
```bash
npx shadcn@latest add alert-dialog
```
This creates `src/components/ui/alert-dialog.tsx`.

**Create SubmitForReviewButton component (submit-for-review-button.tsx):**

A client component that:
1. Accepts props: `inspectionId: string`, `formData: InspectionFormData | null`, `disabled?: boolean`
2. On click, runs `inspectionFormSchema.safeParse(formData)` to collect validation warnings
3. If validation has issues, shows an AlertDialog with:
   - Title: "Submit for Review?"
   - Description: Lists warnings (missing fields) as a bulleted list
   - Footer text: "You can submit anyway -- Dan can request corrections later."
   - Cancel button and "Submit Anyway" button
4. If no validation issues, shows a simpler AlertDialog: "Submit this inspection for review? Dan will be able to see and edit the report."
5. On confirm, calls `fetch(\`/api/inspections/${inspectionId}/submit\`, { method: 'POST' })`
6. On success, shows `toast.success("Inspection submitted for review")` and redirects to `/inspections` via `router.push('/inspections')`
7. On error (409, 401, 403), shows `toast.error()` with the error message
8. While submitting, show loading spinner on the confirm button (disable both buttons)

Import `inspectionFormSchema` from `@/lib/validators/inspection` for the validation check. Import `useRouter` from `next/navigation`. Import toast from `sonner`.

Style: primary button with `Send` icon from lucide-react, min-height 48px, text "Submit for Review".

**Create ReviewNoteBanner component (review-note-banner.tsx):**

A simple client component showing a yellow/amber banner when a returned draft has a review note:
- Props: `note: string | null`
- If `note` is null or empty, render nothing
- Render a banner with amber background, an `AlertTriangle` icon from lucide-react, and the note text
- Include a "Dismiss" button that hides the banner (local state only)
- Style: `bg-amber-50 border border-amber-200 text-amber-800 rounded-lg p-4` with flex layout

**Modify InspectionWizard (inspection-wizard.tsx):**

1. Add `reviewNotes` to the InspectionWizardProps interface:
```typescript
interface InspectionWizardProps {
  inspection: {
    id: string;
    formData: InspectionFormData | null;
    status: string;
    reviewNotes?: string | null;
  };
}
```

2. Import and render `ReviewNoteBanner` at the top of the wizard (above WizardProgress) when `inspection.reviewNotes` is truthy.

3. Import and render `SubmitForReviewButton` on the last step (step index 4). Place it above or inside the wizard navigation area on the last step only. The wizard should show "Submit for Review" instead of or alongside the existing "Submit" button when on the last step AND status is "draft".

4. Pass `form.getValues()` to the SubmitForReviewButton so it can run validation. Use a callback that calls `form.getValues()` at invocation time (not stale data).

**Modify WizardNavigation (wizard-navigation.tsx):**

The existing "Submit" button on the last step is a `type="submit"` button. For the review workflow, replace it. The simplest approach: remove the existing submit button when `isLastStep` and instead render nothing in that spot -- the SubmitForReviewButton handles submission. OR: Keep the existing layout but change the last step button to be the "Submit for Review" button.

Recommended approach: Add an optional `submitButton` ReactNode prop to WizardNavigation. When provided, render it instead of the default submit button on the last step:

```typescript
interface WizardNavigationProps {
  // ... existing props
  submitButton?: React.ReactNode;
}
```

In the JSX, when `isLastStep`:
```tsx
{isLastStep ? (
  submitButton ?? (
    <Button type="submit" disabled={isSubmitting} className="min-h-[48px] px-6 gap-1.5">
      {/* existing submit button content */}
    </Button>
  )
) : ( /* existing next button */ )}
```

Then in InspectionWizard, pass the SubmitForReviewButton as `submitButton` prop:
```tsx
<WizardNavigation
  // ... existing props
  submitButton={
    <SubmitForReviewButton
      inspectionId={inspection.id}
      formData={form.getValues()}
    />
  }
/>
```

**Modify edit page (page.tsx):**

Pass `reviewNotes` from the inspection to the InspectionWizard component:
```typescript
<InspectionWizard
  inspection={{
    id: inspection.id,
    formData: inspection.formData as InspectionFormData | null,
    status: inspection.status,
    reviewNotes: inspection.reviewNotes,
  }}
/>
```

This requires the server component to select `reviewNotes` from the DB. The existing query uses `db.select().from(inspections)` which already returns all columns, so `inspection.reviewNotes` is already available from the Drizzle schema update in Task 1.
  </action>
  <verify>
    <automated>cd "/Users/danielendres/Documents/Dans Stuff/Inspection Form Filler" && npx tsc --noEmit 2>&1 | tail -10 && grep -c "Submit for Review" src/components/inspection/submit-for-review-button.tsx && grep -c "reviewNotes" src/components/inspection/inspection-wizard.tsx</automated>
  </verify>
  <done>
    - SubmitForReviewButton renders on the last wizard step with warn-but-allow validation dialog
    - Clicking "Submit for Review" shows validation warnings but allows proceeding
    - Successful submission redirects to /inspections with success toast
    - ReviewNoteBanner displays when a returned draft has review_notes
    - WizardNavigation accepts optional submitButton override
    - Edit page passes reviewNotes to the wizard
    - No TypeScript errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. All 4 new API route files exist under `src/app/api/inspections/[id]/`
3. Migration file `0004_review_workflow.sql` exists
4. `src/lib/db/schema.ts` includes `reviewNotes`, `finalizedPdfPath`, `reviewedBy`, `notificationSettings` columns
5. SubmitForReviewButton component renders AlertDialog with validation warnings
6. ReviewNoteBanner component displays admin return notes
7. PATCH route rejects field tech edits on non-draft inspections
</verification>

<success_criteria>
- Field tech sees "Submit for Review" button on the last wizard step
- Clicking submit shows an AlertDialog with any validation warnings (missing fields)
- Confirming submission calls POST /api/inspections/[id]/submit and transitions to in_review
- Field tech cannot PATCH an in_review or completed inspection (403 response)
- All status transition endpoints enforce atomic WHERE clause checks (409 on invalid transition)
- Return-note banner appears on returned drafts with the admin's note
- Migration SQL is ready for Supabase SQL Editor application
</success_criteria>

<output>
After completion, create `.planning/phases/04-review-workflow/04-01-SUMMARY.md`
</output>
