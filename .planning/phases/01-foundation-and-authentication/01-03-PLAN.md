---
phase: 01-foundation-and-authentication
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/page.tsx
  - src/app/(dashboard)/admin/users/page.tsx
  - src/components/layout/header.tsx
  - src/components/layout/nav.tsx
  - src/components/layout/mobile-nav.tsx
  - src/components/admin/create-user-form.tsx
  - src/hooks/use-user-role.ts
  - src/types/roles.ts
autonomous: false
requirements:
  - AUTH-02
  - WKFL-03

must_haves:
  truths:
    - "Field tech sees field-tech-appropriate navigation (no admin links)"
    - "Admin sees admin navigation including user management link"
    - "Office staff sees review-related navigation (no admin links)"
    - "Admin can create a new user account from the UI with a role assignment"
    - "Navigation works on mobile (hamburger menu or bottom nav)"
    - "User can log out from the header"
    - "Unauthorized access to /admin/* redirects or shows forbidden"
  artifacts:
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Authenticated dashboard shell with role-aware navigation"
      min_lines: 20
    - path: "src/components/layout/nav.tsx"
      provides: "Navigation component that shows/hides links based on user role"
      exports: ["Nav"]
    - path: "src/components/layout/header.tsx"
      provides: "App header with user info and logout button"
      exports: ["Header"]
    - path: "src/app/(dashboard)/admin/users/page.tsx"
      provides: "Admin-only user management page"
      min_lines: 15
    - path: "src/components/admin/create-user-form.tsx"
      provides: "Form to create new users with role assignment"
      exports: ["CreateUserForm"]
    - path: "src/hooks/use-user-role.ts"
      provides: "React hook to read user_role from JWT client-side"
      exports: ["useUserRole"]
    - path: "src/types/roles.ts"
      provides: "Shared type definitions for roles and navigation"
      exports: ["AppRole", "NavItem"]
  key_links:
    - from: "src/components/layout/nav.tsx"
      to: "src/hooks/use-user-role.ts"
      via: "useUserRole() hook to determine which nav items to show"
      pattern: "useUserRole"
    - from: "src/app/(dashboard)/layout.tsx"
      to: "src/lib/supabase/server.ts"
      via: "createClient() for server-side auth check and redirect"
      pattern: "getUser|redirect"
    - from: "src/components/admin/create-user-form.tsx"
      to: "/api/admin/users"
      via: "fetch POST to create user endpoint"
      pattern: "fetch.*api/admin/users"
    - from: "src/app/(dashboard)/admin/users/page.tsx"
      to: "src/lib/supabase/server.ts"
      via: "Server-side admin role check before rendering"
      pattern: "user_role.*admin|redirect"
---

<objective>
Build the role-based UI shell: dashboard layout with role-aware navigation, header with logout, mobile navigation, and the admin user management page where Dan can create new user accounts.

Purpose: This completes the Phase 1 user experience -- after login, each role sees appropriate UI. Dan can manage users without touching the database directly. This is the visible layer that makes auth and roles tangible.

Output: Complete dashboard shell with role-based navigation and admin user management UI.
</objective>

<execution_context>
@/Users/danielendres/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danielendres/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-and-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-authentication/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create role types, useUserRole hook, and role-aware navigation components</name>
  <files>
    src/types/roles.ts
    src/hooks/use-user-role.ts
    src/components/layout/header.tsx
    src/components/layout/nav.tsx
    src/components/layout/mobile-nav.tsx
  </files>
  <action>
    **Step 1: Define shared role types.**
    Create `src/types/roles.ts`:
    - `AppRole` type: `'admin' | 'field_tech' | 'office_staff'`
    - `NavItem` interface: `{ label: string; href: string; icon?: string; roles: AppRole[] }`
    - `NAV_ITEMS` constant array defining all navigation items with role visibility:
      - Dashboard (`/`): all roles
      - New Inspection (`/inspections/new`): admin, field_tech
      - My Inspections (`/inspections`): field_tech
      - All Inspections (`/inspections`): admin, office_staff
      - Review Queue (`/review`): admin, office_staff
      - Manage Users (`/admin/users`): admin only
    - Note: The destination pages for inspections/review don't exist yet (Phase 2+). The navigation items should still be present -- they'll link to pages built later.

    **Step 2: Create the useUserRole hook.**
    Create `src/hooks/use-user-role.ts` as a client-side hook ('use client' in the file or used in client components):
    - Import `jwtDecode` from `jwt-decode` and `createClient` from `@/lib/supabase/client`
    - Use `useState<AppRole | null>(null)` and `useState<boolean>(true)` for loading
    - In `useEffect`, subscribe to `supabase.auth.onAuthStateChange`:
      - When session exists: decode `session.access_token` with jwtDecode, extract `user_role` claim, set role
      - When no session: set role to null
      - Set loading to false
    - Return `{ role, loading }` object
    - Clean up subscription on unmount

    **Step 3: Build the Header component.**
    Create `src/components/layout/header.tsx` as a client component:
    - Display "SewerTime" branding on the left (text or small logo)
    - Show user email/name on the right (from Supabase session)
    - Logout button: calls `supabase.auth.signOut()` then `router.push('/login')` then `router.refresh()`
    - Use shadcn/ui Button for the logout action
    - Mobile-friendly: hamburger menu trigger on small screens (triggers mobile nav)
    - Professional styling: clean, minimal header bar

    **Step 4: Build the Nav component.**
    Create `src/components/layout/nav.tsx` as a client component:
    - Import `NAV_ITEMS` from `@/types/roles` and `useUserRole` from `@/hooks/use-user-role`
    - Filter NAV_ITEMS to only show items where `item.roles.includes(role)`
    - Render as a vertical sidebar nav on desktop (left side)
    - Highlight the currently active route using `usePathname()`
    - While `loading` is true, show a minimal skeleton/placeholder
    - If role is null (shouldn't happen in dashboard), show nothing

    **Step 5: Build the Mobile Nav component.**
    Create `src/components/layout/mobile-nav.tsx` as a client component:
    - Sheet/drawer pattern using shadcn/ui Sheet component (add it if not installed: `npx shadcn@latest add sheet`)
    - Same nav items as Nav, filtered by role
    - Triggered by hamburger button in Header
    - Closes when a nav item is clicked
    - Only visible on small screens (hidden on md+ breakpoint)
  </action>
  <verify>
    <automated>cd "/Users/danielendres/Documents/Dans Stuff/Inspection Form Filler" && npm run build 2>&1 | tail -20</automated>
    Verify: All component files exist. Types export AppRole, NavItem, NAV_ITEMS. Hook exports useUserRole.
  </verify>
  <done>
    - `src/types/roles.ts` exports AppRole, NavItem, NAV_ITEMS
    - `src/hooks/use-user-role.ts` exports useUserRole returning { role, loading }
    - Header component shows branding, user info, and logout button
    - Nav component filters items by user role
    - Mobile nav works as a slide-out sheet
    - Build completes without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Build dashboard layout, role-based dashboard home, and admin user management page</name>
  <files>
    src/app/(dashboard)/layout.tsx
    src/app/(dashboard)/page.tsx
    src/app/(dashboard)/admin/users/page.tsx
    src/components/admin/create-user-form.tsx
  </files>
  <action>
    **Step 1: Create the dashboard layout.**
    Create `src/app/(dashboard)/layout.tsx` as a server component:
    - Check auth server-side: `const supabase = await createClient()`, `const { data: { user } } = await supabase.auth.getUser()`. If no user, `redirect('/login')`.
    - Layout structure: Header at top, Nav on left (desktop), content area on right
    - Use a standard sidebar layout: `flex` container, sidebar fixed width (e.g., 240px) on lg+ screens, hidden on mobile (mobile nav handles it)
    - Pass user info to Header via props or let Header fetch its own session (client component)
    - The `children` slot renders the page content

    **Step 2: Create the dashboard home page.**
    Create `src/app/(dashboard)/page.tsx` as a server component:
    - Check auth and get user role (server-side via getUser + query user_roles or decode JWT)
    - Display role-appropriate welcome content:
      - Admin: "Welcome, Dan. You have admin access." Show quick links to Manage Users and All Inspections.
      - Field Tech: "Welcome back. Start a new inspection or view your recent inspections." Show quick links.
      - Office Staff: "Welcome. Review pending inspections." Show quick link to review queue.
    - Use shadcn/ui Card components for the quick links
    - This is a placeholder dashboard -- it will be enhanced in later phases with real data
    - Show the user's name and role badge

    **Step 3: Build the admin user management page.**
    Create `src/app/(dashboard)/admin/users/page.tsx` as a server component:
    - **Server-side admin gate:** Check user role. If not admin, redirect to `/` or show a "Forbidden" message. This MUST be enforced server-side, not just hidden in navigation.
    - Display page title: "Manage Users"
    - Render the CreateUserForm component
    - Below the form, show a list of existing users with their roles. Query the profiles + user_roles tables via Drizzle ORM (join profiles with userRoles). Display in a simple table: Name, Email, Role, Created date.

    **Step 4: Build the Create User form.**
    Create `src/components/admin/create-user-form.tsx` as a client component:
    - Form fields: fullName (text), email (email), password (password with min 8 chars), role (select dropdown with options: Field Tech, Office Staff, Admin)
    - Validate with `createUserSchema` from `@/lib/validators/auth.ts` before submitting
    - On submit: POST to `/api/admin/users` with the form data
    - Show success message with created user's name and role
    - Show error message if creation fails
    - Reset form on success
    - Use shadcn/ui form components (Input, Label, Button, Select)
    - Add Select component if not installed: `npx shadcn@latest add select`

    **IMPORTANT decisions honored:**
    - Dan creates all accounts (CONTEXT.md) -- this admin page is the ONLY way to create users
    - Three roles visible in the dropdown: admin, field_tech, office_staff (CONTEXT.md)
    - Field techs see only their own inspections in nav (CONTEXT.md) -- "My Inspections" vs "All Inspections"
    - Admin has full access including user management (CONTEXT.md)
    - Dan-only access on initial launch for testing (CONTEXT.md) -- only Dan's admin account exists initially
  </action>
  <verify>
    <automated>cd "/Users/danielendres/Documents/Dans Stuff/Inspection Form Filler" && npm run build 2>&1 | tail -20</automated>
    Verify: Dashboard layout renders with sidebar nav. Admin page exists at /admin/users. Non-admin redirect works.
  </verify>
  <done>
    - Dashboard layout shows Header + sidebar Nav on desktop, Header + mobile nav on mobile
    - Dashboard home shows role-appropriate welcome content and quick links
    - Admin users page at /admin/users is protected server-side (non-admin redirected)
    - CreateUserForm submits to /api/admin/users and shows success/error feedback
    - Existing users are listed with name, email, role on the admin page
    - Build completes without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 1 auth flow end-to-end</name>
  <action>Human verification of the complete Phase 1 authentication flow. All code is already built -- this checkpoint confirms it works correctly from the user's perspective.</action>
  <what-built>Complete authentication system with role-based UI: branded login, password reset, dashboard with role-aware navigation, admin user management, and database-level access control.</what-built>
  <how-to-verify>
    1. **Login flow:** Visit the deployed Vercel URL. You should see the SewerTime branded login page. Log in with Dan's admin credentials. You should reach the dashboard with admin navigation.

    2. **Admin navigation:** Verify you see: Dashboard, New Inspection, All Inspections, Review Queue, Manage Users in the sidebar.

    3. **Create a test field tech:**
       - Click "Manage Users"
       - Fill in a test user: name, email, password, role = "Field Tech"
       - Click Create. Verify success message.
       - Verify the new user appears in the users list.

    4. **Field tech login:** Log out. Log in as the test field tech. Verify:
       - Dashboard shows field-tech-appropriate welcome
       - Navigation shows: Dashboard, New Inspection, My Inspections (NOT "All Inspections", NOT "Manage Users")
       - Navigating directly to /admin/users redirects away or shows forbidden

    5. **Mobile check:** Resize browser to mobile width. Verify hamburger menu works and shows role-appropriate nav items.

    6. **Password reset:** Log out. Click "Forgot your password?" on login page. Enter an email. Verify the form shows "Check your email" success message. (Note: actual email delivery depends on Supabase email config.)

    7. **Logout:** Verify the logout button works and returns to the login page.
  </how-to-verify>
  <resume-signal>Type "approved" if everything works, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- Admin sees full navigation including user management
- Field tech sees limited navigation (no admin, no "All Inspections")
- Office staff sees review-oriented navigation (no admin)
- Admin can create users with role assignment from the UI
- Non-admin cannot access /admin/users (server-side protection)
- Logout works and returns to login page
- Mobile navigation functions correctly
- Dashboard shows role-appropriate content
</verification>

<success_criteria>
1. Three distinct navigation experiences based on user role
2. Admin user management page creates real users with roles
3. Server-side route protection prevents unauthorized access
4. Mobile-responsive layout with working navigation
5. Logout clears session and returns to login
6. All Phase 1 success criteria from ROADMAP.md are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-authentication/01-03-SUMMARY.md`
</output>
