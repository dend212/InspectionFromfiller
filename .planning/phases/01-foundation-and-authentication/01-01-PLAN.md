---
phase: 01-foundation-and-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - proxy.ts
  - drizzle.config.ts
  - biome.json
  - .env.local
  - .env.example
  - .gitignore
  - src/app/layout.tsx
  - src/app/page.tsx
  - src/app/globals.css
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/supabase/admin.ts
  - src/lib/supabase/proxy.ts
  - src/lib/db/index.ts
  - src/lib/db/schema.ts
  - src/components/ui/*
autonomous: false
requirements:
  - AUTH-01
  - AUTH-02

user_setup:
  - service: supabase
    why: "Database, authentication, and file storage backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon/public key"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role key (keep secret)"
      - name: DATABASE_URL
        source: "Supabase Dashboard -> Project Settings -> Database -> Connection string (Transaction pooler, port 6543). Append ?pgbouncer=true"
    dashboard_config:
      - task: "Create a new Supabase project"
        location: "https://supabase.com/dashboard -> New Project"
  - service: vercel
    why: "Hosting and deployment platform"
    env_vars: []
    dashboard_config:
      - task: "Ensure Vercel account exists and is accessible"
        location: "https://vercel.com/dashboard"

must_haves:
  truths:
    - "Next.js app runs locally with `npm run dev` and renders a page"
    - "Supabase client can connect to the Supabase project (no auth errors on load)"
    - "App deploys to Vercel and loads at the Vercel URL"
    - "Drizzle ORM is configured and can connect to Supabase Postgres"
  artifacts:
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client using createBrowserClient"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server Component Supabase client using createServerClient with cookie handling"
      exports: ["createClient"]
    - path: "src/lib/supabase/admin.ts"
      provides: "Service role Supabase client for admin operations (server-only)"
      exports: ["createAdminClient"]
    - path: "src/lib/supabase/proxy.ts"
      provides: "Session update utility for proxy.ts token refresh"
      exports: ["updateSession"]
    - path: "proxy.ts"
      provides: "Next.js 16 proxy entry point for auth token refresh"
      exports: ["default"]
    - path: "src/lib/db/index.ts"
      provides: "Drizzle database client instance"
      exports: ["db"]
    - path: "src/lib/db/schema.ts"
      provides: "Drizzle table definitions for all Phase 1 tables"
      exports: ["appRoleEnum", "inspectionStatusEnum", "profiles", "userRoles", "inspections", "inspectionMedia"]
    - path: "drizzle.config.ts"
      provides: "Drizzle Kit configuration for migrations"
  key_links:
    - from: "proxy.ts"
      to: "src/lib/supabase/proxy.ts"
      via: "import updateSession"
      pattern: "import.*updateSession.*supabase/proxy"
    - from: "src/lib/db/index.ts"
      to: "src/lib/db/schema.ts"
      via: "import schema for Drizzle client"
      pattern: "import.*schema"
---

<objective>
Scaffold the Next.js 16 project with all foundational dependencies, configure Supabase clients (browser, server, admin), set up Drizzle ORM with the complete database schema, initialize shadcn/ui with SewerTime theming, and deploy to Vercel.

Purpose: Every subsequent plan depends on a running, deployed app with working Supabase connectivity and a defined database schema. This is the foundation everything else builds on.

Output: A deployed Next.js app on Vercel with Supabase clients, Drizzle schema, and shadcn/ui components ready for use.
</objective>

<execution_context>
@/Users/danielendres/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danielendres/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-authentication/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js 16 project with all dependencies and Supabase/Drizzle configuration</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    drizzle.config.ts
    biome.json
    .env.local
    .env.example
    .gitignore
    src/app/layout.tsx
    src/app/page.tsx
    src/app/globals.css
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/lib/supabase/admin.ts
    src/lib/supabase/proxy.ts
    proxy.ts
    src/lib/db/index.ts
    src/lib/db/schema.ts
    src/components/ui/*
  </files>
  <action>
    **Step 1: Create the Next.js project.**
    Run `npx create-next-app@latest . --typescript --tailwind --app --src-dir --use-npm` in the project root. Accept defaults. This gives us Next.js 16 with Turbopack, Tailwind v4, TypeScript, and the App Router with `src/` directory.

    **Step 2: Install all dependencies.**
    ```bash
    npm install @supabase/supabase-js @supabase/ssr drizzle-orm postgres zod jwt-decode
    npm install -D drizzle-kit @biomejs/biome
    ```

    **Step 3: Initialize shadcn/ui.**
    Run `npx shadcn@latest init` -- accept defaults (New York style, Tailwind v4). Then add base components:
    ```bash
    npx shadcn@latest add button input label card form toast
    ```

    **Step 4: Create `.env.local` and `.env.example`.**
    `.env.local` with placeholders (user will fill in real values):
    ```
    NEXT_PUBLIC_SUPABASE_URL=your-project-url
    NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=your-anon-key
    SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
    DATABASE_URL=your-connection-pooler-string
    ```
    `.env.example` with the same keys but descriptive placeholder values (no secrets). Update `.gitignore` to include `.env.local` (should already be there from create-next-app, verify).

    **Step 5: Create Supabase client utilities.**
    Create `src/lib/supabase/client.ts` -- browser client using `createBrowserClient` from `@supabase/ssr` with `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`. Export `createClient` function.

    Create `src/lib/supabase/server.ts` -- server client using `createServerClient` from `@supabase/ssr` with async `cookies()` from `next/headers`. MUST use `getAll`/`setAll` cookie pattern (never individual get/set/remove). Export `createClient` async function.

    Create `src/lib/supabase/admin.ts` -- service role client using `createClient` from `@supabase/supabase-js` with `SUPABASE_SERVICE_ROLE_KEY`. Set `auth: { autoRefreshToken: false, persistSession: false }`. Export `createAdminClient`. Add a comment: "SERVER-ONLY -- never import in client code".

    Create `src/lib/supabase/proxy.ts` -- `updateSession` function following the exact Supabase SSR pattern from RESEARCH.md Pattern 1. Key points: create Supabase server client in the request context, use `getAll`/`setAll` with both request.cookies and supabaseResponse.cookies, call `supabase.auth.getUser()` (NOT getSession), redirect unauthenticated users to `/login` (except `/login`, `/reset-password`, `/auth` paths).

    Create `proxy.ts` at project root (NOT in src/) -- import `updateSession` from `@/lib/supabase/proxy`, export default proxy function, include the matcher config that excludes static files.

    **Step 6: Create Drizzle ORM configuration.**
    Create `drizzle.config.ts` at project root using `defineConfig` from `drizzle-kit`. Set dialect to `postgresql`, schema to `./src/lib/db/schema.ts`, out to `./src/lib/db/migrations`, dbCredentials url from `DATABASE_URL`, schemaFilter `public`, strict and verbose true.

    Create `src/lib/db/index.ts` -- instantiate postgres.js client with `{ prepare: false }` (required for Supabase Transaction pooler). Create and export Drizzle instance with schema.

    Create `src/lib/db/schema.ts` with the complete schema from RESEARCH.md Pattern 5:
    - `appRoleEnum`: pgEnum with values `admin`, `field_tech`, `office_staff`
    - `inspectionStatusEnum`: pgEnum with values `draft`, `submitted`, `in_review`, `completed`, `sent`
    - `profiles` table: id (uuid PK matching auth.users.id), fullName, email, phone, createdAt, updatedAt
    - `userRoles` table: id (identity PK), userId (FK to profiles, cascade delete), role (appRoleEnum), unique constraint on (userId, role)
    - `inspections` table: id (uuid random PK), inspectorId (FK to profiles), status (inspectionStatusEnum default draft), facilityName, facilityAddress, facilityCity, facilityCounty, facilityState (default AZ), facilityZip, formData (jsonb), createdAt, updatedAt, submittedAt, completedAt
    - `inspectionMedia` table: id (uuid random PK), inspectionId (FK to inspections, cascade delete), type (text: photo/video), storagePath, label, sortOrder (default 0), createdAt
    - All relations defined: profiles -> inspections (one-to-many), profiles -> userRoles (one-to-many), inspections -> media (one-to-many)

    **Step 7: Configure Biome.**
    Create `biome.json` with recommended settings. Set formatter indent to 2 spaces, line width 100. Enable linter with recommended rules.

    **Step 8: Update root layout with basic structure.**
    Update `src/app/layout.tsx` with proper metadata (title: "SewerTime Inspections", description: "ADEQ Inspection Form Management"). Ensure Tailwind and global CSS are imported.

    Update `src/app/page.tsx` with a simple placeholder: "SewerTime Inspections" heading centered on screen. This will be replaced in Plan 01-03.

    **Step 9: Add npm scripts to package.json.**
    Add: `"db:generate": "drizzle-kit generate"`, `"db:migrate": "drizzle-kit migrate"`, `"db:push": "drizzle-kit push"`, `"db:studio": "drizzle-kit studio"`, `"lint": "biome check --write ."`, `"format": "biome format --write ."`.

    **IMPORTANT anti-patterns to avoid:**
    - Do NOT use `@supabase/auth-helpers-nextjs` (deprecated, use `@supabase/ssr`)
    - Do NOT use individual cookie get/set/remove (use getAll/setAll)
    - Do NOT use `getSession()` in proxy.ts (use `getUser()`)
    - Do NOT expose SUPABASE_SERVICE_ROLE_KEY in any NEXT_PUBLIC_ variable
    - Do NOT forget `{ prepare: false }` in postgres.js client
    - Do NOT put proxy.ts inside src/ (it goes at project root like middleware.ts did)
  </action>
  <verify>
    <automated>cd "/Users/danielendres/Documents/Dans Stuff/Inspection Form Filler" && npm run build 2>&1 | tail -20</automated>
    Also verify: `npm run dev` starts without errors (check first 5 seconds of output). Verify all Supabase client files exist and export the expected functions. Verify schema.ts exports all tables and enums.
  </verify>
  <done>
    - `npm run build` completes without errors
    - `npm run dev` starts the dev server
    - All four Supabase client files exist with correct exports (client.ts, server.ts, admin.ts, proxy.ts)
    - proxy.ts exists at project root with updateSession import
    - drizzle.config.ts exists and schema.ts exports all 4 tables + 2 enums + relations
    - .env.example exists with all required env var keys
    - shadcn/ui components are installed (button, input, label, card, form, toast in src/components/ui/)
    - Biome config exists and `npm run lint` works
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: User configures Supabase project and Vercel deployment</name>
  <action>Configure external services that require dashboard access</action>
  <instructions>
    **Part A: Supabase Setup**
    1. Go to https://supabase.com/dashboard and create a new project (or use existing)
    2. From Project Settings -> API, copy these values into `.env.local`:
       - `NEXT_PUBLIC_SUPABASE_URL` = Project URL
       - `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` = anon/public key
       - `SUPABASE_SERVICE_ROLE_KEY` = service_role key
    3. From Project Settings -> Database -> Connection string, copy the Transaction pooler string (port 6543) into `DATABASE_URL` in `.env.local`. Replace `[YOUR-PASSWORD]` with your database password.

    **Part B: Verify local connection**
    After filling in `.env.local`, run `npm run dev` and verify the app loads at http://localhost:3000 without Supabase connection errors in the terminal.

    **Part C: Deploy to Vercel**
    1. Run `npx vercel --yes` from the project root to link and deploy
    2. During setup, when prompted for environment variables, add the same 4 variables from `.env.local`
    3. Alternatively: go to Vercel Dashboard -> Project -> Settings -> Environment Variables and add them manually
    4. Verify the deployed URL loads the placeholder page

    Type "done" when Supabase is connected locally and the app is deployed to Vercel.
  </instructions>
  <resume-signal>Type "done" when Supabase project is created, env vars are filled in, app runs locally, and Vercel deployment is live</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` completes without TypeScript or build errors
- `npm run dev` starts and the app loads at http://localhost:3000
- All Supabase client files exist and export correctly
- Drizzle schema defines all tables (profiles, userRoles, inspections, inspectionMedia)
- The app is deployed and accessible on Vercel
- `.env.local` has real Supabase credentials (verified by successful local dev server)
</verification>

<success_criteria>
1. Running Next.js 16 app with TypeScript, Tailwind v4, and App Router
2. Supabase clients (browser, server, admin) configured and working
3. proxy.ts handles token refresh following official Supabase SSR pattern
4. Drizzle ORM configured with complete database schema
5. shadcn/ui initialized with base components
6. App deployed to Vercel at a working URL
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-authentication/01-01-SUMMARY.md`
</output>
